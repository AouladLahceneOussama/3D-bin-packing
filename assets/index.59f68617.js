var G=Object.defineProperty,H=Object.defineProperties;var E=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var j=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable;var _=(h,e,t)=>e in h?G(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t,P=(h,e)=>{for(var t in e||(e={}))j.call(e,t)&&_(h,t,e[t]);if(R)for(var t of R(e))V.call(e,t)&&_(h,t,e[t]);return h},L=(h,e)=>H(h,E(e));var D=(h,e,t)=>(_(h,typeof e!="symbol"?e+"":e,t),t);import*as u from"https://threejsfundamentals.org/threejs/resources/threejs/r122/build/three.module.js";import{OrbitControls as J}from"https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/controls/OrbitControls.js";import{GLTFLoader as F}from"https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/loaders/GLTFLoader.js";const U=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerpolicy&&(i.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?i.credentials="include":a.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=t(a);fetch(a.href,i)}};U();$(document).ready(function(){$(".menuIcon").click(function(){$(".menu").toggleClass("openMenu closeMenu"),$(".menuIcon").toggleClass("openMenuIcon closeMenu")}),$(".closeMenuIcon").click(function(){$(".menu").toggleClass("openMenu closeMenu"),$(".menuIcon").toggleClass("openMenuIcon closeMenu")}),$("#reset").click(function(){localStorage.removeItem("container"),localStorage.removeItem("packages"),location.reload()}),$("#openCSV").click(function(){$("#openCSV").toggleClass("fa-circle-plus fa-circle-minus"),$("#csv").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openApi").click(function(){$("#openApi").toggleClass("fa-circle-plus fa-circle-minus"),$("#api").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openPackages").click(function(){$("#openPackages").toggleClass("fa-circle-plus fa-circle-minus"),$("#packages").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openVehicule").click(function(){$("#openVehicule").toggleClass("fa-circle-plus fa-circle-minus"),$("#vehicule").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openResult").click(function(){$("#openResult").toggleClass("fa-circle-plus fa-circle-minus"),$("#result").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openPackDetail").click(function(){$("#openPackDetail").toggleClass("fa-circle-plus fa-circle-minus"),$("#packDetail").toggleClass("pack-detail-close pack-detail-open")});var h=JSON.parse(localStorage.getItem("container"));if(h!==null){var e=h.w+" , "+h.h+" , "+h.l;$("#containerDetails").append("<span>"+e+"</span>")}});const p=100,g=new u.Scene,C=document.getElementById("3D-container");let X=0;const N=class{constructor(e,t){this.id=X++,this.action=e,this.executionTime=t,N.allMessages.push(this.getMessageDetail)}get getMessageDetail(){return{id:this.id,action:this.action,executionTime:this.executionTime}}dateTime(){var e=new Date,t=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate(),s=e.getHours()+":"+e.getMinutes()+":"+e.getSeconds();return t+" - "+s}dispatchMessage(){console.log("dispatch message");let e="<div class='logTime'><p>"+this.dateTime()+"</p><p>Execution Time : "+this.executionTime.toFixed(2)+"s</p></div>",t=" <div class='logDetail'><h3>"+this.action+"</h3>"+e+"</div>";$(".logMsg").append(t),$(".logMsg").animate({scrollTop:$(".logMsg").prop("scrollHeight")},500)}};let I=N;D(I,"allMessages",[]);let Y=0;const m=class{constructor(e,t,s,a,i,n,l,o){this.id=Y++,this.label=e,this.w=parseInt(t*p),this.h=parseInt(s*p),this.l=parseInt(a*p),this.q=parseInt(i),this.v=this.w*this.h*this.l,this.stackingCapacity=parseInt(n),this.rotations=l,this.dimensions=this.setDimensions(l),this.priority=parseInt(o),this.color=Math.random(),m.allInstances.push(this.getPack)}get getPack(){return{id:this.id,label:this.label,w:this.w,h:this.h,l:this.l,q:this.q,v:this.v,priority:this.priority,stackC:this.stackingCapacity,rotations:this.dimensions,rotateDirections:this.rotations,color:this.color}}get getPackToLocalStorage(){return{label:this.label,w:this.w/p,h:this.h/p,l:this.l/p,q:this.q,priority:this.priority,stackC:this.stackingCapacity,rotations:this.rotations}}setDimensions(e){let t=[];for(let a=0;a<e.length;a++){let i=e[a];i=="base"&&t.push({w:this.w,h:this.h,l:this.l,type:[i,0],surface:this.w*this.l},{w:this.l,h:this.h,l:this.w,type:[i,90],surface:this.w*this.l}),i=="right-side"&&t.push({w:this.w,h:this.l,l:this.h,type:[i,0],surface:this.w*this.h},{w:this.h,h:this.l,l:this.w,type:[i,90],surface:this.w*this.h}),i=="front-side"&&t.push({w:this.h,h:this.w,l:this.l,type:[i,0],surface:this.h*this.l},{w:this.l,h:this.w,l:this.h,type:[i,90],surface:this.h*this.l})}t.sort((a,i)=>i.surface-a.surface);for(let a=0;a<t.length;a+=2)if(t[a].l>t[a].w){var s=t[a+1];t[a+1]=t[a],t[a]=s}return t}static init(){localStorage.getItem("packages")!==null&&(JSON.parse(localStorage.getItem("packages")).forEach(t=>{new m(t.label,t.w,t.h,t.l,t.q,t.stackC,t.rotations,t.priority)}),m.allInstances.forEach(t=>{var s=t.w/p+" , "+t.h/p+" , "+t.l/p+" ( "+t.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+t.label+'</div><div class="packInfo-numbers">'+s+" </div></div>")}))}add(){var e=[];localStorage.getItem("packages")!==null&&(e=JSON.parse(localStorage.getItem("packages"))),e.push(this.getPackToLocalStorage),localStorage.setItem("packages",JSON.stringify(e)),m.loadPacks(),new I("Adding Pack",.01).dispatchMessage()}static updatePackLocalstorage(){localStorage.removeItem("packages");let e=[];m.allInstances.map(t=>{e.push({label:t.label,w:parseFloat(t.w/p),h:parseFloat(t.h/p),l:parseFloat(t.l/p),q:parseInt(t.q),priority:t.priority,stackC:parseInt(t.stackC),rotations:t.rotateDirections})}),localStorage.setItem("packages",JSON.stringify(e))}static update(e,t){function s(c,r,f,d){let y=[];for(let v=0;v<c.length;v++){let x=c[v];x=="base"&&y.push({w:r,h:f,l:d,type:[x,0],surface:r*d},{w:d,h:f,l:r,type:[x,90],surface:r*d}),x=="right-side"&&y.push({w:r,h:d,l:f,type:[x,0],surface:r*f},{w:f,h:d,l:r,type:[x,90],surface:r*f}),x=="front-side"&&y.push({w:f,h:r,l:d,type:[x,0],surface:f*d},{w:d,h:r,l:f,type:[x,90],surface:f*d})}y.sort((v,x)=>x.surface-v.surface);for(let v=0;v<y.length;v+=2)if(y[v].l>y[v].w){var z=y[v+1];y[v+1]=y[v],y[v]=z}return y}let a=m.allInstances.findIndex(c=>c.id==parseInt(t)),i=m.allInstances[a],n={label:e.label,w:parseInt(e.w),h:parseInt(e.h),l:parseInt(e.l),q:parseInt(e.q),priority:parseInt(e.priority),v:e.w*e.h*e.l,stackC:parseInt(e.stack),rotateDirections:e.r,rotations:s(e.r,parseInt(e.w),parseInt(e.h),parseInt(e.l))},l=P(P({},i),n);m.allInstances[a]=l,m.removePacksFromTheScene(),m.updatePackLocalstorage(),$("#packageDetails").empty(),m.allInstances.forEach(c=>{var r=c.w/p+" , "+c.h/p+" , "+c.l/p+" ( "+c.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+c.label+'</div><div class="packInfo-numbers">'+r+" </div></div>")}),new I("Updating Pack",.01).dispatchMessage()}static remove(e){let t=m.allInstances.findIndex(a=>a.id==parseInt(e));m.allInstances.splice(t,1),m.removePacksFromTheScene(),m.updatePackLocalstorage(),$("#packageDetails").empty(),m.allInstances.forEach(a=>{var i=a.w/p+" , "+a.h/p+" , "+a.l/p+" ( "+a.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+a.label+'</div><div class="packInfo-numbers">'+i+" </div></div>")}),new I("Remove Pack",.01).dispatchMessage()}static loadPacks(){m.removeBoxesFromTheScene();let e=m.allInstances,t=new u.Group;t.name="pack_shower",e.sort((o,c)=>c.v-o.v);var s,a,i;let n=-300,l=400;for(let o=0;o<e.length;o++){let c=e[o];a=new u.BoxGeometry(c.w,c.h,c.l),i=new u.MeshLambertMaterial({color:c.color*16715775,side:u.DoubleSide}),s=new u.Mesh(a,i),s.castShadow=!0,s.receiveShadow=!0,s.userData.id=c.id,s.userData.clickable=!0,s.userData.actif=!1,s.userData.name="Pack",o!=0?s.position.set(n,-110-.1,l):s.position.set(n,-65,l),n+=c.w+20,n>800&&(l+=400,n=-300),a.translate(c.w/2,c.h/2,c.l/2),t.add(s)}g.add(t)}static loadPacksFromLocalStorage(){m.init(),m.loadPacks()}static removePacksFromTheScene(){g.remove(g.getObjectByName("All_Packs"))}static removeBoxesFromTheScene(){g.remove(g.getObjectByName("pack_shower"))}};let w=m;D(w,"allInstances",[]);const W=new u.Raycaster,O=new u.Vector2;function Z(h){O.x=(h.clientX-C.offsetLeft)/(window.innerWidth-C.offsetLeft)*2-1,O.y=-((h.clientY-C.offsetTop)/(window.innerHeight-C.offsetTop))*2+1,W.setFromCamera(O,k);var e;if(g.getObjectByName("pack_shower")&&(e=W.intersectObjects(g.getObjectByName("pack_shower").children),e.length>0&&e[0].object.userData.clickable)){let t=e[0].object.userData.id;Q(t),K(t)}}function Q(h){var e;g.traverse(t=>{(t.userData.name==="Pack"||t.userData.name=="Line")&&t.userData.id==h&&(e=t.userData.actif)}),g.traverse(t=>{(t.userData.name==="Pack"||t.userData.name=="Line")&&(e?(t.material.transparent=!1,t.material.opacity=1,t.userData.actif=!1,t.castShadow=!0):(t.userData.id==h&&(t.userData.actif=!0,t.material.transparent=!1,t.material.opacity=1,t.castShadow=!0),t.userData.id!=h&&(t.userData.actif=!1,t.material.transparent=!0,t.material.opacity=.2,t.castShadow=!1)))})}function K(h){["base","right-side","front-side"].forEach(t=>{$(`#pack_Detail_${t}`).prop("checked",!1)});var e=w.allInstances.find(t=>t.id==h);$("#pack_Detail_Id").val(e.id),$("#pack_Detail_Label").val(e.label),$("#pack_Detail_Width").val(e.w/p),$("#pack_Detail_Height").val(e.h/p),$("#pack_Detail_Lenght").val(e.l/p),$("#pack_Detail_Quantity").val(e.q),$("#pack_Detail_StackingCapacity").val(e.stackC),$("#pack_Detail_Priority").val(e.priority),e.rotateDirections.forEach(t=>{$(`#pack_Detail_${t}`).prop("checked",!0)}),e.loaded!=null&&e.unloaded!=null&&$("#packStatut").html(" ("+e.loaded+" / "+(e.loaded+e.unloaded)+") ")}var k,S,b,T,B;ee();A();function ee(){const e=window.innerWidth/window.innerHeight,t=1,s=1e4;k=new u.PerspectiveCamera(60,e,t,s),k.position.set(1e3,400,800),g.background=new u.Color(16777215),g.fog=new u.FogExp2(9024235,2e-6),ae(),ne(),se(),oe(),le();let a=new u.DirectionalLight(16777215,.8);a.position.set(120,1e3,-150),a.castShadow=!0,a.shadow.bias=-.001,a.shadow.mapSize.width=4096,a.shadow.mapSize.height=4096,a.shadow.camera.near=.5,a.shadow.camera.far=3e3,a.shadow.camera.left=3e3,a.shadow.camera.right=-3e3,a.shadow.camera.top=1e3,a.shadow.camera.bottom=-1e3,g.add(a),S=new u.WebGLRenderer({antialias:!0}),S.setPixelRatio(window.devicePixelRatio),S.setSize(C.clientWidth,C.clientHeight),S.shadowMap.enabled=!0,C.appendChild(S.domElement),b=new J(k,S.domElement),b.enableDamping=!0,b.minDistance=100,b.maxDistance=3e3,b.enablePan=!1,b.maxPolarAngle=Math.PI/2,b.minPolarAngle=-Math.PI/2,b.update(),window.addEventListener("resize",te),C.addEventListener("click",Z)}function te(){k.aspect=window.innerWidth/window.innerHeight,k.updateProjectionMatrix(),S.setSize(window.innerWidth,window.innerHeight)}function A(){requestAnimationFrame(A),b.update(),ie()}function ie(){S.render(g,k)}function ae(){const h=new u.TextureLoader,e=h.load("textures/ground/Concrete_019_BaseColor.jpg"),t=h.load("textures/ground/Concrete_019_Normal.jpg"),s=h.load("textures/ground/Concrete_019_Height.png"),a=h.load("textures/ground/Concrete_019_Roughness.jpg"),i=h.load("textures/ground/Concrete_019_AmbientOcclusion.jpg"),n=1800,l=1800,o=6,c=6,r=new u.PlaneGeometry(n,l,10,10),f=new u.MeshStandardMaterial({map:e,normalMap:t,displacementMap:s,displacementScale:.3,roughnessMap:a,roughness:1,aoMap:i});for(let d=0;d<o;d++)for(let y=0;y<c;y++){const z=new u.Mesh(r,f);z.castShadow=!1,z.receiveShadow=!0,z.rotation.x=-Math.PI/2,z.position.y=-110,z.position.x=d*n-o/2*n,z.position.z=y*l-c/2*l,g.add(z)}}function ne(){const h=`
  varying vec3 vWorldPosition;
  void main() {
    vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
    vWorldPosition = worldPosition.xyz;
    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
  }`,e=`
  uniform vec3 topColor;
  uniform vec3 bottomColor;
  uniform float offset;
  uniform float exponent;
  varying vec3 vWorldPosition;
  void main() {
    float h = normalize( vWorldPosition + offset ).y;
    gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h , 0.0), exponent ), 0.0 ) ), 1.0 );
  }`,t=new u.HemisphereLight(16777215,268435455,.6);t.color.setHSL(.6,1,.6),t.groundColor.setHSL(.095,1,.75),g.add(t);const s={topColor:{value:new u.Color(30719)},bottomColor:{value:new u.Color(16777215)},offset:{value:33},exponent:{value:.6}};s.topColor.value.copy(t.color),g.fog.color.copy(s.bottomColor.value);const a=new u.SphereBufferGeometry(4e3,32,15),i=new u.ShaderMaterial({uniforms:s,vertexShader:h,fragmentShader:e,side:u.BackSide}),n=new u.Mesh(a,i);g.add(n)}function se(){new F().load("models/lift_truck/scene.gltf",function(h){const e=h.scene;e&&(e.getObjectByName("holders").translateZ(10),e.scale.set(300,300,300),e.position.set(-250,-90,450),e.rotation.y=-Math.PI,e.traverse(function(s){s.isMesh&&(s.castShadow=!0,s.receiveShadow=!0)}),g.add(e))}),new F().load("models/pallet_truck/scene.gltf",function(h){const e=h.scene;e&&(e.scale.set(1/2,1/2,1/2),e.position.set(-450,-25,700),e.rotation.y=Math.PI,e.traverse(function(t){t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0)}),g.add(e))})}function oe(){new F().load("models/truck/truck-wheels.gltf",function(h){const e=h.scene;e&&(e.scale.set(1.5,2,1.5),e.rotation.y=Math.PI/2,e.traverse(function(t){t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0)}),T=e)}),new F().load("models/truck/truck-support.gltf",function(h){const e=h.scene;e&&(e.scale.set(2,2.4,2),e.rotation.y=Math.PI/2,e.traverse(function(t){t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0)}),B=e)})}function le(){$(".cube__face").click(function(){let h=$(this).attr("role");h=="front"&&gsap.to(k.position,{duration:1,x:2e3,y:100,z:0,ease:"power3.inOut"}),h=="left"&&gsap.to(k.position,{duration:1,x:0,y:200,z:2e3,ease:"power3.inOut"}),h=="top"&&gsap.to(k.position,{duration:1,x:2e3,y:1e3,z:1200,ease:"power3.inOut"})})}function re(){g.remove(g.getObjectByName("Full_Container")),g.remove(g.getObjectByName("All_Packs")),$("#result").empty()}const q=class{constructor(e,t,s,a){this.w=parseInt(e*p),this.h=parseInt(t*p),this.l=parseInt(s*p),this.capacity=parseInt(a),this.loadContainer(),q.instances=this.getContainer}get getContainer(){return{w:this.w,h:this.h,l:this.l,capacity:this.capacity}}get getContainerLocalStorage(){return{w:this.w/p,h:this.h/p,l:this.l/p,capacity:this.capacity}}loadContainer(){var e=new u.MeshLambertMaterial({color:9737364,side:u.DoubleSide}),t=new u.MeshLambertMaterial({color:9737364,side:u.DoubleSide,transparent:!0,opacity:.5}),s,a=new u.Group;a.name="Full_Container";const i=new u.BoxGeometry(this.w+5,5,this.l+5),n=new u.BoxGeometry(this.w+5,this.h,5),l=new u.BoxGeometry(5,this.h,this.l);i.translate(this.w/2-5/2,-5/2-.1,this.l/2-5/2),n.translate(this.w/2-5/2,this.h/2,-5/2-.1),l.translate(-5/2-.1,this.h/2,this.l/2),s=new u.Mesh(i,e),a.add(s),s.castShadow=!0,s.receiveShadow=!0,s=new u.Mesh(n,t),a.add(s),s=new u.Mesh(l,t),a.add(s),this.loadTruck(this.w,this.l,a),localStorage.setItem("container",JSON.stringify(this.getContainerLocalStorage)),new I("Loading container",.01).dispatchMessage()}loadTruck(e,t,s){T.position.set(e-440,-110,t/2),B.position.set(400,-110,t/2),s.add(T),s.add(B),g.add(s)}};let M=q;D(M,"instances");class ce{constructor(e){D(this,"isPointContainedInSpace",(e,t,s)=>s?t.x>e[0].x&&t.x<=e[3].x&&t.z>e[0].z&&t.z<=e[3].z:t.x>=e[0].x&&t.x<=e[3].x&&t.z>=e[0].z&&t.z<=e[3].z);this.algorithm=e,this.packagesLoaded=[],this.openPoints=[{x:0,y:0,z:0}],this.boxes=[]}initialisePackagesToLoad(){var e,t=[],s=[];w.allInstances.map(i=>{for(var n=0;n<i.q;n++)e=L(P({},i),{w:i.rotations[0].w,h:i.rotations[0].h,l:i.rotations[0].l,id:i.id+"-"+n,parent_id:i.id}),delete e.q,t.push(e)});let a=t.reduce((i,n)=>{const l=n.priority;return i[l]==null&&(i[l]=[]),i[l].push(n),i},{});return Object.entries(a).forEach(([i,n])=>{s.push(parseInt(i)),n.sort((l,o)=>o.v-l.v)}),s.sort((i,n)=>i-n),[a,s]}canFit(e,t){return t.w<=e.w&&t.l<=e.l&&t.h<=e.h}getDownPack(e,t,s){return e==-1||e.parent_id!=s?t:(e=this.getPackByTopCoords({x:e.x,y:e.y,z:e.z}),t++,this.getDownPack(e,t,s))}getPackByTopCoords(e){return this.packagesLoaded.filter(s=>s.openPoint.T.x==e.x&&s.openPoint.T.y==e.y&&s.openPoint.T.z==e.z)[0]||-1}canBeStacked(e,t){let s=this.getPackByOpenPoint(t);return s.parent_id==e.parent_id?this.getDownPack(s,0,e.parent_id)<=e.stackC:!0}create2dSpace(e){let t=this.packagesLoaded.filter(a=>(e.y>0?a.y+a.h:a.y)==e.y),s=[];return t.forEach(a=>{s[a.id]==null&&(s[a.id]=[]),s[a.id].push({x:a.x,z:a.z},{x:a.x+a.w,z:a.z},{x:a.x,z:a.z+a.l},{x:a.x+a.w,z:a.z+a.l})}),[t,s]}canFitAboveTheBoxNewVersion(e,t){let s=[{x:t.x,z:t.z},{x:(3*t.x+(t.x+e.w))/4,z:t.z},{x:(t.x+(t.x+e.w))/2,z:t.z},{x:(t.x+3*(t.x+e.w))/4,z:t.z},{x:t.x+e.w,z:t.z},{x:t.x,z:(t.z+3*(t.z+e.l))/4},{x:t.x,z:(t.z+(t.z+e.l))/2},{x:t.x,z:(3*t.z+(t.z+e.l))/4},{x:t.x,z:t.z+e.l},{x:(t.x+3*(t.x+e.w))/4,z:t.z+e.l},{x:(t.x+(t.x+e.w))/2,z:t.z+e.l},{x:(3*t.x+(t.x+e.w))/4,z:t.z+e.l},{x:t.x+e.w,z:t.z+e.l},{x:t.x+e.w,z:(t.z+3*(t.z+e.l))/4},{x:t.x+e.w,z:(t.z+(t.z+e.l))/2},{x:t.x+e.w,z:(3*t.z+(t.z+e.l))/4}],a=this.create2dSpace(t),i=a[0],n=a[1],l=0;for(let o=0;o<s.length;o++)for(let c=0;c<i.length;c++){let r=i[c],f=s[o],d=n[r.id];if(this.isPointContainedInSpace(d,f,!1)){l++;break}}return l==16}okRotation(e,t){for(let s=0;s<this.openPoints.length;s++){let a=this.openPoints[s],i=P({},t);if(!(a.y>0&&a.type=="T"&&t.stackC!=-1&&!this.canBeStacked(t,a))){for(let n=0;n<t.rotations.length;n++){let l=t.rotations[n];if(l.l+a.z<=e.l&&l.h+a.y<=e.h&&l.w+a.x<=e.w){let o=this.createTemperoryBox(l,a);if(this.checkCollision(o)||a.y>0&&!this.canFitAboveTheBoxNewVersion(l,a))continue;return i.w=l.w,i.l=l.l,i.h=l.h,i.validRotation=l.type,[a,s,i]}}if(s==this.openPoints.length-1)return!1}}}removeNonWorkingOpenPoints(e){let t=this.packagesLoaded[this.packagesLoaded.length-1];for(let a=this.openPoints.length-1;a>=0;a--){let i=this.openPoints[a];(e.w==i.x||e.h==i.y||e.l==i.z)&&this.openPoints.splice(a,1)}let s=[];this.openPoints.map((a,i)=>{a.x+1>=t.x&&a.x+1<=t.x+t.w&&a.z+1>=t.z&&a.z+1<=t.z+t.l&&a.y==t.y&&a.pointOwner!=t.id&&s.push(i)}),s.sort((a,i)=>i-a);for(let a=0;a<s.length;a++)this.openPoints.splice(s[a],1);for(let a=0;a<this.openPoints.length;a++){let i=this.openPoints[a],n=i.pointOwner.split("-")[0];for(let l=a+1;l<this.openPoints.length;l++){let o=this.openPoints[l],c=o.pointOwner.split("-")[0];if(i.x==o.x&&i.y==o.y&&i.type!="S"&&n==c){let r=this.packagesLoaded.filter(d=>i.y==0?d.y==i.y&&d.x>i.x&&d.z<=i.z&&d.z+d.l>=i.z:d.y+d.h==i.y&&d.x<=i.x+1&&d.x+d.w>=i.x+1&&d.z<=i.z+1&&d.z+d.l>=i.z+1),f=this.packagesLoaded.filter(d=>o.y==0?d.y==o.y&&d.x>o.x&&d.z<=o.z&&d.z+d.l>=o.z:d.y+d.h==o.y&&d.x<=o.x+1&&d.x+d.w>=o.x+1&&d.z<=o.z+1&&d.z+d.l>=o.z+1);r.length!=0&&f.length!=0&&Math.abs(r[0].x-i.x)==Math.abs(f[0].x-o.x)&&this.openPoints.splice(l,1),r.length==0&&f.length==0&&this.openPoints.splice(l,1)}i.x==o.x&&i.z==o.z&&this.openPoints.splice(l,1),i.y==o.y&&i.z==o.z&&!i.ignored&&o.type!="S"&&this.openPoints.splice(l,1)}}}refreshOpenPoints(e,t){this.openPoints.splice(e,1),this.openPoints=this.removeDuplicatesObjectFromArray(this.openPoints),this.sortOpenPoints(),this.removeNonWorkingOpenPoints(t)}removeDuplicatesObjectFromArray(e){return e.filter((t,s,a)=>a.findIndex(i=>i.x===t.x&&i.y===t.y&&i.z===t.z)===s)}getDifference(e,t){return e.filter(s=>!t.some(a=>s.id===a.parent_id))}removeOpenPointForNextPriority(){let e=[];if(this.openPoints.map((t,s)=>{t.type=="T"&&e.push({data:t,index:s})}),e.length>0){e.sort((s,a)=>a.data.y-s.data.y);let t=e[0].data.y;e.sort((s,a)=>a.index-s.index);for(let s=e.length-1;s>=0;s--){let a=e[s];a.data.y==t&&this.openPoints.splice(a.index,1)}}}getIndexes(e){let t=[];return this.openPoints.map((s,a)=>{parseInt(s.type!=null&&s.type=="T"&&s.pointOwner.split("-")[0])==e.parent_id&&t.push({index:a,data:s})}),t}removeDiagonalPoints(e){let t=this.getIndexes(e),s=[];if(t.length>=2){for(let i=0;i<t.length;i++){let n=t[i];for(let l=i+1;l<t.length;l++){let o=t[l];Math.abs(o.data.z-n.data.z)%2==0&&n.data.y==o.data.y&&s.push(o.index)}}let a=[...new Set(s)];a.sort((i,n)=>n-i),a.map(i=>{this.openPoints.splice(i,1)})}}sortOpenPoints(){this.openPoints.sort((e,t)=>e.x-t.x||e.z-t.z||e.y-t.y)}solve(e,t,s){for(let a=0;a<s.length;a++){let i=t[s[a]];for(let n=0;n<i.length;n++){let l=i[n],o=this.okRotation(e,l);o!==!1&&(this.createPack(o[2],o[0]),this.refreshOpenPoints(o[1],e),this.openPoints.push(...this.createSidePoints()),this.sortOpenPoints(),this.packagesLoaded.length>=2&&this.packagesLoaded[this.packagesLoaded.length-1].parent_id!=this.packagesLoaded[this.packagesLoaded.length-2].parent_id&&this.removeDiagonalPoints(this.packagesLoaded[this.packagesLoaded.length-2]))}}return console.log("packagesLoaded => "),console.log(this.packagesLoaded),console.log("openPoints => "),console.log(this.openPoints),[this.openPoints,this.packagesLoaded]}checkCollision(e){e.geometry.computeBoundingBox(),e.updateMatrixWorld();let t=e.geometry.boundingBox.clone();t.applyMatrix4(e.matrixWorld),t.max.x=t.max.x-1,t.max.y=t.max.y-1,t.max.z=t.max.z-1,t.min.x=t.min.x+1,t.min.y=t.min.y+1,t.min.z=t.min.z+1;for(let s=0;s<this.boxes.length;s++){let a=this.boxes[s];a.geometry.computeBoundingBox(),a.updateMatrixWorld();let i=a.geometry.boundingBox.clone();if(i.applyMatrix4(a.matrixWorld),i.max.x=i.max.x-1,i.max.y=i.max.y-1,i.max.z=i.max.z-1,i.min.x=i.min.x+1,i.min.y=i.min.y+1,i.min.z=i.min.z+1,t.intersectsBox(i))return t.intersectsBox(i)}return!1}createTemperoryBox(e,t){let s=new u.MeshLambertMaterial({color:e.color*16715775,side:u.DoubleSide}),a=new u.BoxGeometry(e.w,e.h,e.l),i=new u.Mesh(a,s),n=new u.Vector3(t.x,t.y,t.z);return i.position.copy(n),a.translate(e.w/2,e.h/2,e.l/2),i}getPackByOpenPoint(e){return this.packagesLoaded.filter(s=>s.id===e.pointOwner)[0]}getPackById(e){return this.packagesLoaded.filter(s=>s.parent_id===e)[0]}createSidePoints(){let e=this.packagesLoaded[this.packagesLoaded.length-1],t=[],s=this.openPoints.filter(i=>i.y==e.y&&i.x<e.x+e.w&&i.pointOwner!=e.id&&i.type!="S"&&!i.ignored);s.sort((i,n)=>i.z-n.z),console.log(e,s);var a=null;if(s.length>0){if(e.z+e.l-s[0].z>0){let i=e.openPoint.F,n=s[0];if(this.packagesLoaded.filter(o=>o.x>i.x&&o.x<=n.x&&o.z>i.z&&o.z<=n.z&&o.y==i.y).length==0){let o={pointOwner:e.id,x:e.x+e.w,y:e.y,z:s[0].z,type:"S",ignored:!1},c=this.packagesLoaded.filter(r=>{if(o.y>0)return r.y+r.h==o.y&&r.x<=o.x+1&&r.x+r.w>=o.x+1&&r.z<=o.z+1&&r.z+r.l>=o.z+1});if(e.y==0){let r=this.packagesLoaded.filter(f=>f.x<=o.x&&f.x+f.w>=o.x&&f.z<=o.z&&f.z+f.l>=o.z);(o.z==0||r.length!=0)&&(t.push(o),a=this.openPoints.findIndex(f=>f.x==s[0].x&&f.y==e.y&&f.z==s[0].z))}else c.length>0&&(t.push(o),a=this.openPoints.findIndex(r=>r.x==s[0].x&&r.y==e.y&&r.z==s[0].z))}}if(e.z+e.l-s[0].z<0){let i=e.openPoint.F,n=s[0];if(this.packagesLoaded.filter(o=>o.x>=n.x&&o.x<=i.x&&o.z+1>i.z&&o.z+1<=n.z&&o.y==i.y).length==0){let o={pointOwner:e.id,x:s[0].x,y:e.y,z:e.z+e.l,type:"S",ignored:!1},c=this.packagesLoaded.filter(r=>{if(o.y>0)return r.y+r.h==o.y&&r.x<=o.x+1&&r.x+r.w>=o.x+1&&r.z<=o.z+1&&r.z+r.l>=o.z+1});if(e.y==0){let r=this.packagesLoaded.filter(f=>f.x<=o.x&&f.x+f.w>=o.x&&f.z<=o.z&&f.z+f.l>=o.z);(o.z==0||r.length!=0)&&(t.push(o),a=this.openPoints.findIndex(f=>f.x==e.x&&f.y==e.y&&f.z==e.z+e.l))}else c.length>0&&(t.push(o),a=this.openPoints.findIndex(r=>r.x==e.x&&r.y==e.y&&r.z==e.z+e.l))}}a!=-1&&a!=null&&(this.openPoints[a].ignored=!0)}return t}createOpenPoints(e,t){let s=[{pointOwner:t.id,x:e.x,y:e.y+t.h,z:e.z,type:"T",ignored:!1}],a=[{pointOwner:t.id,x:e.x,y:e.y,z:e.z+t.l,type:"R",ignored:!1},{pointOwner:t.id,x:e.x+t.w,y:e.y,z:e.z,type:"F",ignored:!1}];if(e.x==0&&e.y==0&&e.z==0)return[...s,...a];let i=this.create2dSpace(e),n=i[0],l=i[1];if(n.length!=0&&Object.keys(l).length!=0)for(let o=0;o<a.length;o++){let c=a[o],r=0;for(let f=0;f<n.length;f++){let d=n[f],y=l[d.id],z={x:c.x+1,z:c.z+1};c.y==0?this.isPointContainedInSpace(y,z,!1)||r++:this.isPointContainedInSpace(y,z,!1)&&this.packagesLoaded.filter(x=>x.x<=c.x&&x.x+x.w>c.x&&x.z<=c.z&&x.z+x.l>c.z&&x.y==e.y&&x.id!=c.pointOwner).length==0&&(c.type=="R"&&s.push(a[0]),c.type=="F"&&s.push(a[1]))}r==n.length&&(c.type=="R"&&s.push(a[0]),c.type=="F"&&s.push(a[1]))}return s}createPack(e,t){this.packagesLoaded.push(L(P(P({},e),t),{openPoint:{R:{x:t.x,y:t.y,z:t.z+e.l},T:{x:t.x,y:t.y+e.h,z:t.z},F:{x:t.x+e.w,y:t.y,z:t.z}}})),this.openPoints.push(...this.createOpenPoints(t,e)),this.boxes.push(this.createTemperoryBox(e,t))}}function he(h,e){let t=new u.Group;t.name="All_Packs",e.forEach(i=>{let n=new u.BoxGeometry(i.w,i.h,i.l),l=new u.MeshLambertMaterial({color:i.color*16715775,side:u.DoubleSide}),o=new u.Vector3(i.x,i.y,i.z),c=new u.Group;c.name="Box_Border_"+i.parent_id;let r=new u.Mesh(n,l);r.castShadow=!0,r.receiveShadow=!0,r.name="Pack",r.userData.id=i.parent_id,r.userData.clickable=!1,r.userData.actif=!1,r.userData.name="Pack";let f=new u.EdgesGeometry(n),d=new u.LineSegments(f,new u.LineBasicMaterial({color:16777215}));d.name="Line_"+i.id,d.position.copy(o),d.userData.id=i.parent_id,d.userData.name="Line",d.translateX(i.w/2),d.translateY(i.h/2),d.translateZ(i.l/2),r.position.copy(o),n.translate(i.w/2,i.h/2,i.l/2),c.add(r),c.add(d),t.add(c)});var s=gsap.timeline();for(let i=0;i<t.children.length;i++)s.from(t.children[i].position,{x:2e3,y:0,z:0,ease:Bounce.easeOut,duration:.02,onUpdate:()=>t.children[0].position.needsUpdate=!0});let a=new u.Group;a.name="sphere",h.forEach(i=>{const n=new u.SphereGeometry(3,32,16),l=new u.MeshBasicMaterial({color:16776960}),o=new u.Mesh(n,l);o.position.set(i.x,i.y,i.z),a.add(o)}),g.add(a),g.add(t)}function de(h,e){return h.filter(t=>!e.some(s=>t.id===s.parent_id))}function ue(h,e){$("#result").empty(),fe(e);let t=e.reduce((n,l)=>{let o=l.parent_id,c=h.filter(r=>r.id==o)[0].q;return n[o]==null&&(n[o]={id:l.parent_id,label:l.label,loaded:0,unloaded:0}),n[o].loaded=n[o].loaded+1,n[o].unloaded=c-n[o].loaded,n},{}),a=de(h,e).reduce((n,l)=>(n[l.id]==null&&(n[l.id]={id:l.id,label:l.label,loaded:0,unloaded:l.q}),n),{}),i=P(P({},t),a);for(let n=0;n<w.allInstances.length;n++){let l=w.allInstances[n].id;w.allInstances[n]=L(P({},w.allInstances[n]),{loaded:i[l].loaded,unloaded:i[l].unloaded})}for(const n in i){let l="<span class='result-text'><b>Id</b><span>"+i[n].id+"</span></span>",o="<span class='result-text'><b>Label</b><span>"+i[n].label+"</span></span>",c="<span class='result-text'><b>Loaded</b><span>"+i[n].loaded+"</span></span>",r="<span class='result-text'><b>Unloaded</b><span>"+i[n].unloaded+"</span></span>";$("#result").append("<div class='result-detail'>"+l+o+c+r+"</div>")}}function fe(h){const e="data:text/csv;charset=utf-8,"+[["Id","Label","Width","Height","Lenght","X","Y","Z","RotationFace","RotationAngle"],...h.map(a=>[a.id,a.label,a.w,a.h,a.l,a.x,a.y,a.z,a.validRotation])].map(a=>a.join(",")).join(`
`);var t=encodeURI(e);let s="result_"+new Date().getTime()+".csv";$("#result").append("<a class='download-result' href="+t+" download="+s+"> Download <b>"+s+"</b> </div>")}$(document).ready(function(){const h=new Worker("src/worker.js",{type:"module"});var e=!1,t=JSON.parse(localStorage.getItem("container"));t!==null&&($("#containerWidth").val(t.w),$("#containerHeight").val(t.h),$("#containerLenght").val(t.l)),$("#containerForm").submit(function(i){i.preventDefault();var n={};n.w=$("#containerWidth").val(),n.h=$("#containerHeight").val(),n.l=$("#containerLenght").val(),n.weight=0,re(),new M(n.w,n.h,n.l,0),e=!0;var l=JSON.parse(localStorage.getItem("container"));if(l!==null){var o=l.w+" , "+l.h+" , "+l.l;$("#containerDetails").html("<span>"+o+"</span>")}}),$("#packForm").submit(function(i){if(i.preventDefault(),!e){alert("create the container");return}var n={},l;n.label=$("#packLabel").val(),n.w=$("#packWidth").val(),n.h=$("#packHeight").val(),n.l=$("#packLenght").val(),n.q=$("#packQuantity").val(),n.stack=$("#packStackingCapacity").val(),n.priority=$("#packPriority").val(),n.r=["base"],$("#rightSide").is(":checked")&&n.r.push("right-side"),$("#frontSide").is(":checked")&&n.r.push("front-side"),l=new w(n.label,n.w,n.h,n.l,n.q,n.stack,n.r,n.priority),l.add();var o=n.w+" , "+n.h+" , "+n.l+" ( "+n.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+n.label+'</div><div class="packInfo-numbers">'+o+" </div></div>")}),$("#solve").click(function(){if(!e){alert("create the container");return}w.removePacksFromTheScene(),g.remove(g.getObjectByName("sphere"));var i=new ce("cub"),n=i.initialisePackagesToLoad();new I("Loading",.01).dispatchMessage(),h.postMessage([M.instances,n]),h.onmessage=o=>{he(o.data.packer[0],o.data.packer[1]),ue(w.allInstances,o.data.packer[1]),$("#numberBox").val(o.data.packer[1].length),new I("Loaded",o.data.executionTime).dispatchMessage()}}),w.loadPacksFromLocalStorage(),$("#updatePack").click(function(i){i.preventDefault();var n={};n.id=$("#pack_Detail_Id").val(),n.label=$("#pack_Detail_Label").val(),n.w=$("#pack_Detail_Width").val()*p,n.h=$("#pack_Detail_Height").val()*p,n.l=$("#pack_Detail_Lenght").val()*p,n.q=$("#pack_Detail_Quantity").val(),n.stack=$("#pack_Detail_StackingCapacity").val(),n.priority=$("#pack_Detail_Priority").val(),n.r=["base"],$("#pack_Detail_right-side").is(":checked")&&n.r.push("right-side"),$("#pack_Detail_front-side").is(":checked")&&n.r.push("front-side"),w.update(n,n.id),w.removeBoxesFromTheScene(),w.loadPacks()}),$("#deletePack").click(function(i){i.preventDefault();let n=$("#pack_Detail_Id").val();w.remove(n),w.removeBoxesFromTheScene(),w.loadPacks()}),$("#actual-btn").change(function(i){var n=$("#actual-btn").val().split(".").pop().toLowerCase();if($.inArray(n,["csv"])==-1)return alert("Upload CSV"),!1;if(i.target.files!=null){$("#file-chosen").html(i.target.files[0].name);var l=new FileReader;l.onload=function(o){var c=o.target.result.split(`\r
`);s(c)},l.readAsText(i.target.files.item(0))}return!1});function s(i){for(let o=1;o<i.length;o++)if(i[o].length>0){let c=i[o].split(",");if(c[0]=="container")new M(c[1],c[2],c[3],c[4]),e=!0;else{let r=[];for(let f=6;f<=8;f++)c[f]!=null&&r.push(c[f].replace('"',""));var n=new w(c[0],c[1],c[2],c[3],c[4],c[5],[...r]);n.add();var l=c[1]+" , "+c[2]+" , "+c[3]+" ( "+c[4]+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+c[0]+'</div><div class="packInfo-numbers">'+l+" </div></div>")}}}$("#numberBox").on("input",function(i){if(i.target.value!=null&&g.getObjectByName("All_Packs")){let n=g.getObjectByName("All_Packs").children;i.target.max=n.length;for(let l=i.target.value-1;l>=0;l--){let o=n[l].children,c=o[0],r=o[1];c.visible=!0,r.visible=!0}for(let l=n.length-1;l>=i.target.value;l--){let o=n[l].children,c=o[0],r=o[1];c.visible=!1,r.visible=!1}}}),$("#loadApi").click(async function(){let i=$("#apiUrl").val();await fetch(i).then(n=>{if(n.ok)return n.json()}).then(n=>{console.log(n),a(n)}).catch(n=>console.log(n))});function a(i){console.log(i);let n=i.container,l=i.colis;new M(n.w,n.h,n.l,n.capacity),e=!0,l.map(r=>{var r=new w(r.label,r.w,r.h,r.l,r.q,r.stackingCapacity,r.rotations,r.priority);r.add();var f=r.w+" , "+r.h+" , "+r.l+" ( "+r.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+r.label+'</div><div class="packInfo-numbers">'+f+" </div></div>")}),new I("Load Data",.01).dispatchMessage()}$("#random").click(function(){$("#packLabel").val("colis "+Math.floor(Math.random()*100)),$("#packWidth").val(Math.floor((Math.random()*(2-.1+1)+.1)*100)/100),$("#packHeight").val(Math.floor((Math.random()*(2-.1+1)+.1)*100)/100),$("#packLenght").val(Math.floor((Math.random()*(2-.1+1)+.1)*100)/100),$("#packQuantity").val(Math.floor(Math.random()*20+1))})});
