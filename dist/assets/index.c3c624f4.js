var H=Object.defineProperty,E=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var A=Object.getOwnPropertySymbols;var j=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable;var _=(c,t,e)=>t in c?H(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e,v=(c,t)=>{for(var e in t||(t={}))j.call(t,e)&&_(c,e,t[e]);if(A)for(var e of A(t))V.call(t,e)&&_(c,e,t[e]);return c},L=(c,t)=>E(c,G(t));var D=(c,t,e)=>(_(c,typeof t!="symbol"?t+"":t,e),e);import*as u from"https://threejsfundamentals.org/threejs/resources/threejs/r122/build/three.module.js";import{OrbitControls as J}from"https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/controls/OrbitControls.js";import{GLTFLoader as F}from"https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/loaders/GLTFLoader.js";const U=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function e(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerpolicy&&(i.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?i.credentials="include":a.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(a){if(a.ep)return;a.ep=!0;const i=e(a);fetch(a.href,i)}};U();$(document).ready(function(){$(".menuIcon").click(function(){$(".menu").toggleClass("openMenu closeMenu"),$(".menuIcon").toggleClass("openMenuIcon closeMenu")}),$(".closeMenuIcon").click(function(){$(".menu").toggleClass("openMenu closeMenu"),$(".menuIcon").toggleClass("openMenuIcon closeMenu")}),$("#reset").click(function(){localStorage.removeItem("container"),localStorage.removeItem("packages"),location.reload()}),$("#openCSV").click(function(){$("#openCSV").toggleClass("fa-circle-plus fa-circle-minus"),$("#csv").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openApi").click(function(){$("#openApi").toggleClass("fa-circle-plus fa-circle-minus"),$("#api").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openPackages").click(function(){$("#openPackages").toggleClass("fa-circle-plus fa-circle-minus"),$("#packages").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openVehicule").click(function(){$("#openVehicule").toggleClass("fa-circle-plus fa-circle-minus"),$("#vehicule").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openResult").click(function(){$("#openResult").toggleClass("fa-circle-plus fa-circle-minus"),$("#result").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openPackDetail").click(function(){$("#openPackDetail").toggleClass("fa-circle-plus fa-circle-minus"),$("#packDetail").toggleClass("pack-detail-close pack-detail-open")});var c=JSON.parse(localStorage.getItem("container"));if(c!==null){var t=c.w+" , "+c.h+" , "+c.l;$("#containerDetails").append("<span>"+t+"</span>")}});const f=100,p=new u.Scene,S=document.getElementById("3D-container");let X=0;const x=class{constructor(t,e,o,a,i,n,r,s){this.id=X++,this.label=t,this.w=parseInt(e*f),this.h=parseInt(o*f),this.l=parseInt(a*f),this.q=parseInt(i),this.v=this.w*this.h*this.l,this.stackingCapacity=parseInt(n),this.rotations=r,this.dimensions=this.setDimensions(r),this.priority=parseInt(s),this.color=Math.random(),x.allInstances.push(this.getPack)}get getPack(){return{id:this.id,label:this.label,w:this.w,h:this.h,l:this.l,q:this.q,v:this.v,priority:this.priority,stackC:this.stackingCapacity,rotations:this.dimensions,rotateDirections:this.rotations,color:this.color}}get getPackToLocalStorage(){return{label:this.label,w:this.w/f,h:this.h/f,l:this.l/f,q:this.q,priority:this.priority,stackC:this.stackingCapacity,rotations:this.rotations}}setDimensions(t){let e=[];for(let a=0;a<t.length;a++){let i=t[a];i=="base"&&e.push({w:this.w,h:this.h,l:this.l,type:[i,0],surface:this.w*this.l},{w:this.l,h:this.h,l:this.w,type:[i,90],surface:this.w*this.l}),i=="right-side"&&e.push({w:this.w,h:this.l,l:this.h,type:[i,0],surface:this.w*this.h},{w:this.h,h:this.l,l:this.w,type:[i,90],surface:this.w*this.h}),i=="front-side"&&e.push({w:this.h,h:this.w,l:this.l,type:[i,0],surface:this.h*this.l},{w:this.l,h:this.w,l:this.h,type:[i,90],surface:this.h*this.l})}e.sort((a,i)=>i.surface-a.surface);for(let a=0;a<e.length;a+=2)if(e[a].l>e[a].w){var o=e[a+1];e[a+1]=e[a],e[a]=o}return e}static init(){localStorage.getItem("packages")!==null&&(JSON.parse(localStorage.getItem("packages")).forEach(e=>{new x(e.label,e.w,e.h,e.l,e.q,e.stackC,e.rotations,e.priority)}),x.allInstances.forEach(e=>{var o=e.w/f+" , "+e.h/f+" , "+e.l/f+" ( "+e.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+e.label+'</div><div class="packInfo-numbers">'+o+" </div></div>")}))}add(){var t=[];localStorage.getItem("packages")!==null&&(t=JSON.parse(localStorage.getItem("packages"))),t.push(this.getPackToLocalStorage),localStorage.setItem("packages",JSON.stringify(t)),x.loadPacks()}static updatePackLocalstorage(){localStorage.removeItem("packages");let t=[];x.allInstances.map(e=>{t.push({label:e.label,w:parseFloat(e.w/f),h:parseFloat(e.h/f),l:parseFloat(e.l/f),q:parseInt(e.q),priority:e.priority,stackC:parseInt(e.stackC),rotations:e.rotateDirections})}),localStorage.setItem("packages",JSON.stringify(t))}static update(t,e){function o(s,l,h,g){let d=[];for(let m=0;m<s.length;m++){let y=s[m];y=="base"&&d.push({w:l,h,l:g,type:[y,0],surface:l*g},{w:g,h,l,type:[y,90],surface:l*g}),y=="right-side"&&d.push({w:l,h:g,l:h,type:[y,0],surface:l*h},{w:h,h:g,l,type:[y,90],surface:l*h}),y=="front-side"&&d.push({w:h,h:l,l:g,type:[y,0],surface:h*g},{w:g,h:l,l:h,type:[y,90],surface:h*g})}d.sort((m,y)=>y.surface-m.surface);for(let m=0;m<d.length;m+=2)if(d[m].l>d[m].w){var k=d[m+1];d[m+1]=d[m],d[m]=k}return d}let a=x.allInstances.findIndex(s=>s.id==parseInt(e)),i=x.allInstances[a],n={label:t.label,w:parseInt(t.w),h:parseInt(t.h),l:parseInt(t.l),q:parseInt(t.q),priority:parseInt(t.priority),v:t.w*t.h*t.l,stackC:parseInt(t.stack),rotateDirections:t.r,rotations:o(t.r,parseInt(t.w),parseInt(t.h),parseInt(t.l))},r=v(v({},i),n);x.allInstances[a]=r,x.removePacksFromTheScene(),x.updatePackLocalstorage(),$("#packageDetails").empty(),x.allInstances.forEach(s=>{var l=s.w/f+" , "+s.h/f+" , "+s.l/f+" ( "+s.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+s.label+'</div><div class="packInfo-numbers">'+l+" </div></div>")})}static remove(t){let e=x.allInstances.findIndex(o=>o.id==parseInt(t));x.allInstances.splice(e,1),x.removePacksFromTheScene(),x.updatePackLocalstorage(),$("#packageDetails").empty(),x.allInstances.forEach(o=>{var a=o.w/f+" , "+o.h/f+" , "+o.l/f+" ( "+o.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+o.label+'</div><div class="packInfo-numbers">'+a+" </div></div>")})}static loadPacks(){x.removeBoxesFromTheScene();let t=x.allInstances,e=new u.Group;e.name="pack_shower",t.sort((s,l)=>l.v-s.v);var o,a,i;let n=-300,r=400;for(let s=0;s<t.length;s++){let l=t[s];a=new u.BoxGeometry(l.w,l.h,l.l),i=new u.MeshLambertMaterial({color:l.color*16715775,side:u.DoubleSide}),o=new u.Mesh(a,i),o.castShadow=!0,o.receiveShadow=!0,o.userData.id=l.id,o.userData.clickable=!0,o.userData.actif=!1,o.userData.name="Pack",s!=0?o.position.set(n,-110-.1,r):o.position.set(n,-65,r),n+=l.w+20,n>800&&(r+=400,n=-300),a.translate(l.w/2,l.h/2,l.l/2),e.add(o)}p.add(e)}static loadPacksFromLocalStorage(){x.init(),x.loadPacks()}static removePacksFromTheScene(){p.remove(p.getObjectByName("All_Packs"))}static removeBoxesFromTheScene(){p.remove(p.getObjectByName("pack_shower"))}};let w=x;D(w,"allInstances",[]);const R=new u.Raycaster,O=new u.Vector2;function Y(c){O.x=(c.clientX-S.offsetLeft)/(window.innerWidth-S.offsetLeft)*2-1,O.y=-((c.clientY-S.offsetTop)/(window.innerHeight-S.offsetTop))*2+1,R.setFromCamera(O,z);var t;if(p.getObjectByName("pack_shower")&&(t=R.intersectObjects(p.getObjectByName("pack_shower").children),t.length>0&&t[0].object.userData.clickable)){let e=t[0].object.userData.id;Z(e),Q(e)}}function Z(c){var t;p.traverse(e=>{(e.userData.name==="Pack"||e.userData.name=="Line")&&e.userData.id==c&&(t=e.userData.actif)}),p.traverse(e=>{(e.userData.name==="Pack"||e.userData.name=="Line")&&(t?(e.material.transparent=!1,e.material.opacity=1,e.userData.actif=!1,e.castShadow=!0):(e.userData.id==c&&(e.userData.actif=!0,e.material.transparent=!1,e.material.opacity=1,e.castShadow=!0),e.userData.id!=c&&(e.userData.actif=!1,e.material.transparent=!0,e.material.opacity=.2,e.castShadow=!1)))})}function Q(c){["base","right-side","front-side"].forEach(e=>{$(`#pack_Detail_${e}`).prop("checked",!1)});var t=w.allInstances.find(e=>e.id==c);$("#pack_Detail_Id").val(t.id),$("#pack_Detail_Label").val(t.label),$("#pack_Detail_Width").val(t.w/f),$("#pack_Detail_Height").val(t.h/f),$("#pack_Detail_Lenght").val(t.l/f),$("#pack_Detail_Quantity").val(t.q),$("#pack_Detail_StackingCapacity").val(t.stackC),$("#pack_Detail_Priority").val(t.priority),t.rotateDirections.forEach(e=>{$(`#pack_Detail_${e}`).prop("checked",!0)}),t.loaded!=null&&t.unloaded!=null&&$("#packStatut").html(" ("+t.loaded+" / "+(t.loaded+t.unloaded)+") ")}var z,I,P,T,B;K();W();function K(){const t=window.innerWidth/window.innerHeight,e=1,o=1e4;z=new u.PerspectiveCamera(60,t,e,o),z.position.set(1e3,400,800),p.background=new u.Color(16777215),p.fog=new u.FogExp2(9024235,2e-6),ie(),ae(),ne(),oe(),se();let a=new u.DirectionalLight(16777215,.8);a.position.set(120,1e3,-150),a.castShadow=!0,a.shadow.bias=-.001,a.shadow.mapSize.width=4096,a.shadow.mapSize.height=4096,a.shadow.camera.near=.5,a.shadow.camera.far=3e3,a.shadow.camera.left=3e3,a.shadow.camera.right=-3e3,a.shadow.camera.top=1e3,a.shadow.camera.bottom=-1e3,p.add(a),I=new u.WebGLRenderer({antialias:!0}),I.setPixelRatio(window.devicePixelRatio),I.setSize(S.clientWidth,S.clientHeight),I.shadowMap.enabled=!0,S.appendChild(I.domElement),P=new J(z,I.domElement),P.enableDamping=!0,P.minDistance=100,P.maxDistance=3e3,P.enablePan=!1,P.maxPolarAngle=Math.PI/2,P.minPolarAngle=-Math.PI/2,P.update(),window.addEventListener("resize",ee),S.addEventListener("click",Y)}function ee(){z.aspect=window.innerWidth/window.innerHeight,z.updateProjectionMatrix(),I.setSize(window.innerWidth,window.innerHeight)}function W(){requestAnimationFrame(W),P.update(),te()}function te(){I.render(p,z)}function ie(){const c=new u.TextureLoader,t=c.load("textures/ground/Concrete_019_BaseColor.jpg"),e=c.load("textures/ground/Concrete_019_Normal.jpg"),o=c.load("textures/ground/Concrete_019_Height.png"),a=c.load("textures/ground/Concrete_019_Roughness.jpg"),i=c.load("textures/ground/Concrete_019_AmbientOcclusion.jpg"),n=1800,r=1800,s=6,l=6,h=new u.PlaneGeometry(n,r,10,10),g=new u.MeshStandardMaterial({map:t,normalMap:e,displacementMap:o,displacementScale:.3,roughnessMap:a,roughness:1,aoMap:i});for(let d=0;d<s;d++)for(let k=0;k<l;k++){const m=new u.Mesh(h,g);m.castShadow=!1,m.receiveShadow=!0,m.rotation.x=-Math.PI/2,m.position.y=-110,m.position.x=d*n-s/2*n,m.position.z=k*r-l/2*r,p.add(m)}}function ae(){const c=`
  varying vec3 vWorldPosition;
  void main() {
    vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
    vWorldPosition = worldPosition.xyz;
    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
  }`,t=`
  uniform vec3 topColor;
  uniform vec3 bottomColor;
  uniform float offset;
  uniform float exponent;
  varying vec3 vWorldPosition;
  void main() {
    float h = normalize( vWorldPosition + offset ).y;
    gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h , 0.0), exponent ), 0.0 ) ), 1.0 );
  }`,e=new u.HemisphereLight(16777215,268435455,.6);e.color.setHSL(.6,1,.6),e.groundColor.setHSL(.095,1,.75),p.add(e);const o={topColor:{value:new u.Color(30719)},bottomColor:{value:new u.Color(16777215)},offset:{value:33},exponent:{value:.6}};o.topColor.value.copy(e.color),p.fog.color.copy(o.bottomColor.value);const a=new u.SphereBufferGeometry(4e3,32,15),i=new u.ShaderMaterial({uniforms:o,vertexShader:c,fragmentShader:t,side:u.BackSide}),n=new u.Mesh(a,i);p.add(n)}function ne(){new F().load("models/lift_truck/scene.gltf",function(c){const t=c.scene;t&&(t.getObjectByName("holders").translateZ(10),t.scale.set(300,300,300),t.position.set(-250,-90,450),t.rotation.y=-Math.PI,t.traverse(function(o){o.isMesh&&(o.castShadow=!0,o.receiveShadow=!0)}),p.add(t))}),new F().load("models/pallet_truck/scene.gltf",function(c){const t=c.scene;t&&(t.scale.set(1/2,1/2,1/2),t.position.set(-450,-25,700),t.rotation.y=Math.PI,t.traverse(function(e){e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),p.add(t))})}function oe(){new F().load("models/truck/truck-wheels.gltf",function(c){const t=c.scene;t&&(t.scale.set(1.5,2,1.5),t.rotation.y=Math.PI/2,t.traverse(function(e){e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),T=t)}),new F().load("models/truck/truck-support.gltf",function(c){const t=c.scene;t&&(t.scale.set(2,2.4,2),t.rotation.y=Math.PI/2,t.traverse(function(e){e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),B=t)})}function se(){$(".cube__face").click(function(){let c=$(this).attr("role");c=="front"&&gsap.to(z.position,{duration:1,x:2e3,y:100,z:0,ease:"power3.inOut"}),c=="left"&&gsap.to(z.position,{duration:1,x:0,y:200,z:2e3,ease:"power3.inOut"}),c=="top"&&gsap.to(z.position,{duration:1,x:2e3,y:1e3,z:1200,ease:"power3.inOut"})})}function le(){p.remove(p.getObjectByName("Full_Container")),p.remove(p.getObjectByName("All_Packs")),$("#result").empty()}const N=class{constructor(t,e,o,a){this.w=parseInt(t*f),this.h=parseInt(e*f),this.l=parseInt(o*f),this.capacity=parseInt(a),this.loadContainer(),N.instances=this.getContainer}get getContainer(){return{w:this.w,h:this.h,l:this.l,capacity:this.capacity}}get getContainerLocalStorage(){return{w:this.w/f,h:this.h/f,l:this.l/f,capacity:this.capacity}}loadContainer(){var t=new u.MeshLambertMaterial({color:9737364,side:u.DoubleSide}),e=new u.MeshLambertMaterial({color:9737364,side:u.DoubleSide,transparent:!0,opacity:.5}),o,a=new u.Group;a.name="Full_Container";const i=new u.BoxGeometry(this.w+5,5,this.l+5),n=new u.BoxGeometry(this.w+5,this.h,5),r=new u.BoxGeometry(5,this.h,this.l);i.translate(this.w/2-5/2,-5/2-.1,this.l/2-5/2),n.translate(this.w/2-5/2,this.h/2,-5/2-.1),r.translate(-5/2-.1,this.h/2,this.l/2),o=new u.Mesh(i,t),a.add(o),o.castShadow=!0,o.receiveShadow=!0,o=new u.Mesh(n,e),a.add(o),o=new u.Mesh(r,e),a.add(o),this.loadTruck(this.w,this.l,a),localStorage.setItem("container",JSON.stringify(this.getContainerLocalStorage))}loadTruck(t,e,o){T.position.set(t-440,-110,e/2),B.position.set(400,-110,e/2),o.add(T),o.add(B),p.add(o)}};let C=N;D(C,"instances");class re{constructor(t){D(this,"isPointContainedInSpace",(t,e,o)=>o?e.x>t[0].x&&e.x<=t[3].x&&e.z>t[0].z&&e.z<=t[3].z:e.x>=t[0].x&&e.x<=t[3].x&&e.z>=t[0].z&&e.z<=t[3].z);this.algorithm=t,this.packagesLoaded=[],this.openPoints=[{x:0,y:0,z:0}],this.boxes=[]}initialisePackagesToLoad(){var t,e=[],o=[];w.allInstances.map(i=>{for(var n=0;n<i.q;n++)t=L(v({},i),{w:i.rotations[0].w,h:i.rotations[0].h,l:i.rotations[0].l,id:i.id+"-"+n,parent_id:i.id}),delete t.q,e.push(t)});let a=e.reduce((i,n)=>{const r=n.priority;return i[r]==null&&(i[r]=[]),i[r].push(n),i},{});return Object.entries(a).forEach(([i,n])=>{o.push(parseInt(i)),n.sort((r,s)=>s.v-r.v)}),o.sort((i,n)=>i-n),[a,o]}canFit(t,e){return e.w<=t.w&&e.l<=t.l&&e.h<=t.h}getDownPack(t,e,o){return t==-1||t.parent_id!=o?e:(t=this.getPackByTopCoords({x:t.x,y:t.y,z:t.z}),e++,this.getDownPack(t,e,o))}getPackByTopCoords(t){return this.packagesLoaded.filter(o=>o.openPoint.T.x==t.x&&o.openPoint.T.y==t.y&&o.openPoint.T.z==t.z)[0]||-1}canBeStacked(t,e){let o=this.getPackByOpenPoint(e);return o.parent_id==t.parent_id?this.getDownPack(o,0,t.parent_id)<=t.stackC:!0}create2dSpace(t){let e=this.packagesLoaded.filter(a=>(t.y>0?a.y+a.h:a.y)==t.y),o=[];return e.forEach(a=>{o[a.id]==null&&(o[a.id]=[]),o[a.id].push({x:a.x,z:a.z},{x:a.x+a.w,z:a.z},{x:a.x,z:a.z+a.l},{x:a.x+a.w,z:a.z+a.l})}),[e,o]}canFitAboveTheBoxNewVersion(t,e){let o=[{x:e.x,z:e.z},{x:(3*e.x+(e.x+t.w))/4,z:e.z},{x:(e.x+(e.x+t.w))/2,z:e.z},{x:(e.x+3*(e.x+t.w))/4,z:e.z},{x:e.x+t.w,z:e.z},{x:e.x,z:(e.z+3*(e.z+t.l))/4},{x:e.x,z:(e.z+(e.z+t.l))/2},{x:e.x,z:(3*e.z+(e.z+t.l))/4},{x:e.x,z:e.z+t.l},{x:(e.x+3*(e.x+t.w))/4,z:e.z+t.l},{x:(e.x+(e.x+t.w))/2,z:e.z+t.l},{x:(3*e.x+(e.x+t.w))/4,z:e.z+t.l},{x:e.x+t.w,z:e.z+t.l},{x:e.x+t.w,z:(e.z+3*(e.z+t.l))/4},{x:e.x+t.w,z:(e.z+(e.z+t.l))/2},{x:e.x+t.w,z:(3*e.z+(e.z+t.l))/4}],a=this.create2dSpace(e),i=a[0],n=a[1],r=0;for(let s=0;s<o.length;s++)for(let l=0;l<i.length;l++){let h=i[l],g=o[s],d=n[h.id];if(this.isPointContainedInSpace(d,g,!1)){r++;break}}return r==16}okRotation(t,e){for(let o=0;o<this.openPoints.length;o++){let a=this.openPoints[o],i=v({},e);if(!(a.y>0&&a.type=="T"&&e.stackC!=-1&&!this.canBeStacked(e,a))){for(let n=0;n<e.rotations.length;n++){let r=e.rotations[n];if(r.l+a.z<=t.l&&r.h+a.y<=t.h&&r.w+a.x<=t.w){let s=this.createTemperoryBox(r,a);if(this.checkCollision(s)||a.y>0&&!this.canFitAboveTheBoxNewVersion(r,a))continue;return i.w=r.w,i.l=r.l,i.h=r.h,i.validRotation=r.type,[a,o,i]}}if(o==this.openPoints.length-1)return!1}}}removeNonWorkingOpenPoints(t){let e=this.packagesLoaded[this.packagesLoaded.length-1];for(let a=this.openPoints.length-1;a>=0;a--){let i=this.openPoints[a];(t.w==i.x||t.h==i.y||t.l==i.z)&&this.openPoints.splice(a,1)}let o=[];this.openPoints.map((a,i)=>{a.x+1>=e.x&&a.x+1<=e.x+e.w&&a.z+1>=e.z&&a.z+1<=e.z+e.l&&a.y==e.y&&a.pointOwner!=e.id&&o.push(i)}),o.sort((a,i)=>i-a);for(let a=0;a<o.length;a++)this.openPoints.splice(o[a],1);for(let a=0;a<this.openPoints.length;a++){let i=this.openPoints[a],n=i.pointOwner.split("-")[0];for(let r=a+1;r<this.openPoints.length;r++){let s=this.openPoints[r],l=s.pointOwner.split("-")[0];if(i.x==s.x&&i.y==s.y&&i.type!="S"&&n==l){let h=this.packagesLoaded.filter(d=>i.y==0?d.y==i.y&&d.x>i.x&&d.z<=i.z&&d.z+d.l>=i.z:d.y+d.h==i.y&&d.x<=i.x+1&&d.x+d.w>=i.x+1&&d.z<=i.z+1&&d.z+d.l>=i.z+1),g=this.packagesLoaded.filter(d=>s.y==0?d.y==s.y&&d.x>s.x&&d.z<=s.z&&d.z+d.l>=s.z:d.y+d.h==s.y&&d.x<=s.x+1&&d.x+d.w>=s.x+1&&d.z<=s.z+1&&d.z+d.l>=s.z+1);h.length!=0&&g.length!=0&&Math.abs(h[0].x-i.x)==Math.abs(g[0].x-s.x)&&this.openPoints.splice(r,1),h.length==0&&g.length==0&&this.openPoints.splice(r,1)}i.x==s.x&&i.z==s.z&&this.openPoints.splice(r,1),i.y==s.y&&i.z==s.z&&!i.ignored&&s.type!="S"&&this.openPoints.splice(r,1)}}}refreshOpenPoints(t,e){this.openPoints.splice(t,1),this.openPoints=this.removeDuplicatesObjectFromArray(this.openPoints),this.sortOpenPoints(),this.removeNonWorkingOpenPoints(e)}removeDuplicatesObjectFromArray(t){return t.filter((e,o,a)=>a.findIndex(i=>i.x===e.x&&i.y===e.y&&i.z===e.z)===o)}getDifference(t,e){return t.filter(o=>!e.some(a=>o.id===a.parent_id))}removeOpenPointForNextPriority(){let t=[];if(this.openPoints.map((e,o)=>{e.type=="T"&&t.push({data:e,index:o})}),t.length>0){t.sort((o,a)=>a.data.y-o.data.y);let e=t[0].data.y;t.sort((o,a)=>a.index-o.index);for(let o=t.length-1;o>=0;o--){let a=t[o];a.data.y==e&&this.openPoints.splice(a.index,1)}}}getIndexes(t){let e=[];return console.log(t),this.openPoints.map((o,a)=>{parseInt(o.type!=null&&o.type=="T"&&o.pointOwner.split("-")[0])==t.parent_id&&e.push({index:a,data:o})}),e}removeDiagonalPoints(t){let e=this.getIndexes(t),o=[];if(console.log(e),e.length>=2){for(let i=0;i<e.length;i++){let n=e[i];for(let r=i+1;r<e.length;r++){let s=e[r];Math.abs(s.data.z-n.data.z)%2==0&&n.data.y==s.data.y&&o.push(s.index)}}let a=[...new Set(o)];a.sort((i,n)=>n-i),a.map(i=>{this.openPoints.splice(i,1)})}}sortOpenPoints(){this.openPoints.sort((t,e)=>t.x-e.x||t.z-e.z||t.y-e.y)}solve(t,e,o){for(let a=0;a<o.length;a++){let i=e[o[a]];for(let n=0;n<i.length;n++){let r=i[n],s=this.okRotation(t,r);s!==!1&&(this.createPack(s[2],s[0]),this.refreshOpenPoints(s[1],t),this.openPoints.push(...this.createSidePoints()),this.sortOpenPoints(),this.packagesLoaded.length>=2&&this.packagesLoaded[this.packagesLoaded.length-1].parent_id!=this.packagesLoaded[this.packagesLoaded.length-2].parent_id&&this.removeDiagonalPoints(this.packagesLoaded[this.packagesLoaded.length-2]))}}return console.log("packagesLoaded => "),console.log(this.packagesLoaded),console.log("openPoints => "),console.log(this.openPoints),[this.openPoints,this.packagesLoaded]}checkCollision(t){t.geometry.computeBoundingBox(),t.updateMatrixWorld();let e=t.geometry.boundingBox.clone();e.applyMatrix4(t.matrixWorld),e.max.x=e.max.x-1,e.max.y=e.max.y-1,e.max.z=e.max.z-1,e.min.x=e.min.x+1,e.min.y=e.min.y+1,e.min.z=e.min.z+1;for(let o=0;o<this.boxes.length;o++){let a=this.boxes[o];a.geometry.computeBoundingBox(),a.updateMatrixWorld();let i=a.geometry.boundingBox.clone();if(i.applyMatrix4(a.matrixWorld),i.max.x=i.max.x-1,i.max.y=i.max.y-1,i.max.z=i.max.z-1,i.min.x=i.min.x+1,i.min.y=i.min.y+1,i.min.z=i.min.z+1,e.intersectsBox(i))return e.intersectsBox(i)}return!1}createTemperoryBox(t,e){let o=new u.MeshLambertMaterial({color:t.color*16715775,side:u.DoubleSide}),a=new u.BoxGeometry(t.w,t.h,t.l),i=new u.Mesh(a,o),n=new u.Vector3(e.x,e.y,e.z);return i.position.copy(n),a.translate(t.w/2,t.h/2,t.l/2),i}getPackByOpenPoint(t){return this.packagesLoaded.filter(o=>o.id===t.pointOwner)[0]}getPackById(t){return this.packagesLoaded.filter(o=>o.parent_id===t)[0]}createSidePoints(){let t=this.packagesLoaded[this.packagesLoaded.length-1],e=[],o=this.openPoints.filter(i=>i.y==t.y&&i.x<t.x+t.w&&i.pointOwner!=t.id&&i.type!="S");o.sort((i,n)=>i.z-n.z);var a=null;if(o.length>0){if(t.z+t.l-o[0].z>0){let i=t.openPoint.F,n=o[0];if(this.packagesLoaded.filter(s=>s.x>i.x&&s.x<=n.x&&s.z>i.z&&s.z<=n.z&&s.y==i.y).length==0){let s={pointOwner:t.id,x:t.x+t.w,y:t.y,z:o[0].z,type:"S",ignored:!1},l=this.packagesLoaded.filter(h=>{if(s.y>0)return h.y+h.h==s.y&&h.x<=s.x+1&&h.x+h.w>=s.x+1&&h.z<=s.z+1&&h.z+h.l>=s.z+1});(t.y==0||l.length>0)&&e.push(s),a=this.openPoints.findIndex(h=>h.x==o[0].x&&h.y==t.y&&h.z==o[0].z)}}if(t.z+t.l-o[0].z<0){let i=t.openPoint.F,n=o[0];this.packagesLoaded.filter(s=>s.x>=n.x&&s.x<=i.x&&s.z+1>i.z&&s.z+1<=n.z&&s.y==i.y).length==0&&(e.push({pointOwner:t.id,x:o[0].x,y:t.y,z:t.z+t.l,type:"S",ignored:!1}),a=this.openPoints.findIndex(s=>s.x==t.x&&s.y==t.y&&s.z==t.z+t.l))}a!=-1&&a!=null&&(this.openPoints[a].ignored=!0)}return e}createOpenPoints(t,e){let o=[{pointOwner:e.id,x:t.x,y:t.y+e.h,z:t.z,type:"T",ignored:!1}],a=[{pointOwner:e.id,x:t.x,y:t.y,z:t.z+e.l,type:"R",ignored:!1},{pointOwner:e.id,x:t.x+e.w,y:t.y,z:t.z,type:"F",ignored:!1}];if(t.x==0&&t.y==0&&t.z==0)return[...o,...a];let i=this.create2dSpace(t),n=i[0],r=i[1];if(n.length!=0&&Object.keys(r).length!=0)for(let s=0;s<a.length;s++){let l=a[s],h=0;for(let g=0;g<n.length;g++){let d=n[g],k=r[d.id],m={x:l.x+1,z:l.z+1};l.y==0?this.isPointContainedInSpace(k,m,!1)||h++:this.isPointContainedInSpace(k,m,!1)&&this.packagesLoaded.filter(b=>b.x<=l.x&&b.x+b.w>l.x&&b.z<=l.z&&b.z+b.l>l.z&&b.y==t.y&&b.id!=l.pointOwner).length==0&&(l.type=="R"&&o.push(a[0]),l.type=="F"&&o.push(a[1]))}h==n.length&&(l.type=="R"&&o.push(a[0]),l.type=="F"&&o.push(a[1]))}return o}createPack(t,e){this.packagesLoaded.push(L(v(v({},t),e),{openPoint:{R:{x:e.x,y:e.y,z:e.z+t.l},T:{x:e.x,y:e.y+t.h,z:e.z},F:{x:e.x+t.w,y:e.y,z:e.z}}})),this.openPoints.push(...this.createOpenPoints(e,t)),this.boxes.push(this.createTemperoryBox(t,e))}}function ce(c,t){let e=new u.Group;e.name="All_Packs",t.forEach(i=>{let n=new u.BoxGeometry(i.w,i.h,i.l),r=new u.MeshLambertMaterial({color:i.color*16715775,side:u.DoubleSide}),s=new u.Vector3(i.x,i.y,i.z),l=new u.Group;l.name="Box_Border_"+i.parent_id;let h=new u.Mesh(n,r);h.castShadow=!0,h.receiveShadow=!0,h.name="Pack",h.userData.id=i.parent_id,h.userData.clickable=!1,h.userData.actif=!1,h.userData.name="Pack";let g=new u.EdgesGeometry(n),d=new u.LineSegments(g,new u.LineBasicMaterial({color:16777215}));d.name="Line_"+i.id,d.position.copy(s),d.userData.id=i.parent_id,d.userData.name="Line",d.translateX(i.w/2),d.translateY(i.h/2),d.translateZ(i.l/2),h.position.copy(s),n.translate(i.w/2,i.h/2,i.l/2),l.add(h),l.add(d),e.add(l)});var o=gsap.timeline();for(let i=0;i<e.children.length;i++)o.from(e.children[i].position,{x:2e3,y:0,z:0,ease:Bounce.easeOut,duration:.02,onUpdate:()=>e.children[0].position.needsUpdate=!0});let a=new u.Group;a.name="sphere",c.forEach(i=>{const n=new u.SphereGeometry(3,32,16),r=new u.MeshBasicMaterial({color:16776960}),s=new u.Mesh(n,r);s.position.set(i.x,i.y,i.z),a.add(s)}),p.add(a),p.add(e)}function he(c,t){return c.filter(e=>!t.some(o=>e.id===o.parent_id))}function de(c,t){$("#result").empty(),ue(t);let e=t.reduce((n,r)=>{let s=r.parent_id,l=c.filter(h=>h.id==s)[0].q;return n[s]==null&&(n[s]={id:r.parent_id,label:r.label,loaded:0,unloaded:0}),n[s].loaded=n[s].loaded+1,n[s].unloaded=l-n[s].loaded,n},{}),a=he(c,t).reduce((n,r)=>(n[r.id]==null&&(n[r.id]={id:r.id,label:r.label,loaded:0,unloaded:r.q}),n),{}),i=v(v({},e),a);for(let n=0;n<w.allInstances.length;n++){let r=w.allInstances[n].id;w.allInstances[n]=L(v({},w.allInstances[n]),{loaded:i[r].loaded,unloaded:i[r].unloaded})}for(const n in i){let r="<span class='result-text'><b>Id</b><span>"+i[n].id+"</span></span>",s="<span class='result-text'><b>Label</b><span>"+i[n].label+"</span></span>",l="<span class='result-text'><b>Loaded</b><span>"+i[n].loaded+"</span></span>",h="<span class='result-text'><b>Unloaded</b><span>"+i[n].unloaded+"</span></span>";$("#result").append("<div class='result-detail'>"+r+s+l+h+"</div>")}}function ue(c){const t="data:text/csv;charset=utf-8,"+[["Id","Label","Width","Height","Lenght","X","Y","Z","RotationFace","RotationAngle"],...c.map(a=>[a.id,a.label,a.w,a.h,a.l,a.x,a.y,a.z,a.validRotation])].map(a=>a.join(",")).join(`
`);var e=encodeURI(t);let o="result_"+new Date().getTime()+".csv";$("#result").append("<a class='download-result' href="+e+" download="+o+"> Download <b>"+o+"</b> </div>")}let fe=0;const q=class{constructor(t,e){this.id=fe++,this.action=t,this.executionTime=e,q.allMessages.push(this.getMessageDetail)}get getMessageDetail(){return{id:this.id,action:this.action,executionTime:this.executionTime}}dateTime(){var t=new Date,e=t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate(),o=t.getHours()+":"+t.getMinutes()+":"+t.getSeconds();return e+" - "+o}dispatchMessage(){console.log("dispatch message");let t="<div class='logTime'><p>"+this.dateTime()+"</p><p>Execution Time : "+this.executionTime.toFixed(2)+"s</p></div>",e=" <div class='logDetail'><h3>"+this.action+"</h3>"+t+"</div>";$("#logMsg").append(e),$(".logger").animate({scrollTop:$(".logger").prop("scrollHeight")},500)}};let M=q;D(M,"allMessages",[]);$(document).ready(function(){const c=new Worker("src/worker.js",{type:"module"});var t=!1,e=JSON.parse(localStorage.getItem("container"));e!==null&&($("#containerWidth").val(e.w),$("#containerHeight").val(e.h),$("#containerLenght").val(e.l)),$("#containerForm").submit(function(i){i.preventDefault();var n={};n.w=$("#containerWidth").val(),n.h=$("#containerHeight").val(),n.l=$("#containerLenght").val(),n.weight=0,le(),new C(n.w,n.h,n.l,0),t=!0;var r=JSON.parse(localStorage.getItem("container"));if(r!==null){var s=r.w+" , "+r.h+" , "+r.l;$("#containerDetails").html("<span>"+s+"</span>"),new M("Adding container",.01).dispatchMessage()}}),$("#packForm").submit(function(i){if(i.preventDefault(),!t){alert("create the container");return}var n={},r;n.label=$("#packLabel").val(),n.w=$("#packWidth").val(),n.h=$("#packHeight").val(),n.l=$("#packLenght").val(),n.q=$("#packQuantity").val(),n.stack=$("#packStackingCapacity").val(),n.priority=$("#packPriority").val(),n.r=["base"],$("#rightSide").is(":checked")&&n.r.push("right-side"),$("#frontSide").is(":checked")&&n.r.push("front-side"),r=new w(n.label,n.w,n.h,n.l,n.q,n.stack,n.r,n.priority),r.add();var s=n.w+" , "+n.h+" , "+n.l+" ( "+n.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+n.label+'</div><div class="packInfo-numbers">'+s+" </div></div>"),new M("Adding colis",.01).dispatchMessage()}),$("#solve").click(function(){if(!t){alert("create the container");return}w.removePacksFromTheScene(),p.remove(p.getObjectByName("sphere"));var i=new re("cub"),n=i.initialisePackagesToLoad();new M("Loading",.01).dispatchMessage(),c.postMessage([C.instances,n]),c.onmessage=s=>{console.log("solved"),console.log(s),ce(s.data.packer[0],s.data.packer[1]),de(w.allInstances,s.data.packer[1]),$("#numberBox").val(s.data.packer[1].length),new M("Loaded",s.data.executionTime).dispatchMessage()}}),w.loadPacksFromLocalStorage(),$("#updatePack").click(function(i){i.preventDefault();var n={};n.id=$("#pack_Detail_Id").val(),n.label=$("#pack_Detail_Label").val(),n.w=$("#pack_Detail_Width").val()*f,n.h=$("#pack_Detail_Height").val()*f,n.l=$("#pack_Detail_Lenght").val()*f,n.q=$("#pack_Detail_Quantity").val(),n.stack=$("#pack_Detail_StackingCapacity").val(),n.priority=$("#pack_Detail_Priority").val(),n.r=["base"],$("#pack_Detail_right-side").is(":checked")&&n.r.push("right-side"),$("#pack_Detail_front-side").is(":checked")&&n.r.push("front-side"),w.update(n,n.id),w.removeBoxesFromTheScene(),w.loadPacks()}),$("#deletePack").click(function(i){i.preventDefault();let n=$("#pack_Detail_Id").val();w.remove(n),w.removeBoxesFromTheScene(),w.loadPacks()}),$("#actual-btn").change(function(i){var n=$("#actual-btn").val().split(".").pop().toLowerCase();if($.inArray(n,["csv"])==-1)return alert("Upload CSV"),!1;if(i.target.files!=null){$("#file-chosen").html(i.target.files[0].name);var r=new FileReader;r.onload=function(s){var l=s.target.result.split(`\r
`);o(l)},r.readAsText(i.target.files.item(0))}return!1});function o(i){for(let s=1;s<i.length;s++)if(i[s].length>0){let l=i[s].split(",");if(l[0]=="container")new C(l[1],l[2],l[3],l[4]),t=!0;else{let h=[];for(let g=6;g<=8;g++)l[g]!=null&&h.push(l[g].replace('"',""));var n=new w(l[0],l[1],l[2],l[3],l[4],l[5],[...h]);n.add();var r=l[1]+" , "+l[2]+" , "+l[3]+" ( "+l[4]+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+l[0]+'</div><div class="packInfo-numbers">'+r+" </div></div>")}}}$("#numberBox").on("input",function(i){if(i.target.value!=null&&p.getObjectByName("All_Packs")){let n=p.getObjectByName("All_Packs").children;i.target.max=n.length;for(let r=i.target.value-1;r>=0;r--){let s=n[r].children,l=s[0],h=s[1];l.visible=!0,h.visible=!0}for(let r=n.length-1;r>=i.target.value;r--){let s=n[r].children,l=s[0],h=s[1];l.visible=!1,h.visible=!1}}}),$("#loadApi").click(async function(){let i=$("#apiUrl").val();await fetch(i).then(n=>{if(n.ok)return n.json()}).then(n=>{console.log(n),a(n)}).catch(n=>console.log(n))});function a(i){console.log(i);let n=i.container,r=i.colis;new C(n.w,n.h,n.l,n.capacity),t=!0,r.map(l=>{var l=new w(l.label,l.w,l.h,l.l,l.q,l.stackingCapacity,l.rotations,l.priority);l.add();var h=l.w+" , "+l.h+" , "+l.l+" ( "+l.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+l.label+'</div><div class="packInfo-numbers">'+h+" </div></div>")})}$("#random").click(function(){$("#packLabel").val("colis "+Math.floor(Math.random()*100)),$("#packWidth").val(Math.floor((Math.random()*(2-.1+1)+.1)*100)/100),$("#packHeight").val(Math.floor((Math.random()*(2-.1+1)+.1)*100)/100),$("#packLenght").val(Math.floor((Math.random()*(2-.1+1)+.1)*100)/100),$("#packQuantity").val(Math.floor(Math.random()*20+1))})});
