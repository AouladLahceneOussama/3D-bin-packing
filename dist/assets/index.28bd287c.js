var le=Object.defineProperty,re=Object.defineProperties;var ce=Object.getOwnPropertyDescriptors;var ie=Object.getOwnPropertySymbols;var ue=Object.prototype.hasOwnProperty,he=Object.prototype.propertyIsEnumerable;var H=(g,t,e)=>t in g?le(g,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):g[t]=e,L=(g,t)=>{for(var e in t||(t={}))ue.call(t,e)&&H(g,e,t[e]);if(ie)for(var e of ie(t))he.call(t,e)&&H(g,e,t[e]);return g},j=(g,t)=>re(g,ce(t));var D=(g,t,e)=>(H(g,typeof t!="symbol"?t+"":t,e),e);import*as f from"https://threejsfundamentals.org/threejs/resources/threejs/r122/build/three.module.js";import{OrbitControls as de}from"https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/controls/OrbitControls.js";import{GLTFLoader as pe}from"https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/loaders/GLTFLoader.js";import{TransformControls as fe}from"https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/controls/TransformControls.js";const ge=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerpolicy&&(a.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?a.credentials="include":i.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}};ge();const w=100,v=new f.Scene,S=document.getElementById("3D-container"),ne=document.getElementById("exampleModalfat");let me=0;const K=class{constructor(t,e){this.id=me++,this.action=t,this.executionTime=e,K.allMessages.push(this.getMessageDetail)}get getMessageDetail(){return{id:this.id,action:this.action,executionTime:this.executionTime}}dateTime(){var t=new Date,e=t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate(),o=t.getHours()+":"+t.getMinutes()+":"+t.getSeconds();return e+" - "+o}dispatchMessage(){let t="<div class='logTime'><p>"+this.dateTime()+"</p><p>Execution Time : "+this.executionTime.toFixed(2)+"s</p></div>",e=" <div class='logDetail'><h3>"+this.action+"</h3>"+t+"</div>";$(".logMsg").append(e),$(".logMsg").animate({scrollTop:$(".logMsg").prop("scrollHeight")},250)}};let F=K;D(F,"allMessages",[]);let ye=0;const R=class{constructor(t=0,e=[]){this.id=ye++,this.routeNumber=parseInt(t),console.log(e),this.routes=e,R.allRoutes=this.getRoute}get getRoute(){return console.log(this.routes),{routeNumber:this.routeNumber,routes:this.routes}}get getRouteToLocalStorage(){return{routeNumber:this.routeNumber,routes:this.routes}}static getRouteNumber(t){return R.allRoutes.routes.filter(o=>(console.log(o.type,t),o.type==t)).length}static initialisePriorityFields(){$("#packPriority option").remove(),$("#pack_Detail_Priority option").remove();for(let t=1;t<=R.getRouteNumber("dechargement");t++)$("#packPriority").append('<option value="'+t+'">'+t+"</option>"),$("#pack_Detail_Priority").append('<option value="'+t+'">'+t+"</option>")}static init(){localStorage.getItem("routes")!==null&&(JSON.parse(localStorage.getItem("routes")).forEach(e=>{new R(e.routeNumber,e.from,e.to,e.type)}),R.allRoutes.routes.forEach(e=>{var o=e.from+" - "+e.to+"("+e.type+")",i="p : "+e.id;$("#routesDetails").append('<div class="packInfo"><div>'+o+'</div><div class="packInfo-numbers">'+i+" </div></div>")}),R.initialisePriorityFields())}add(){var t=[];localStorage.getItem("routes")!==null&&(t=JSON.parse(localStorage.getItem("routes"))),t.push(this.getRouteToLocalStorage),localStorage.setItem("routes",JSON.stringify(t)),R.allRoutes.routes.forEach(o=>{var i=o.from+" - "+o.to+"("+o.type+")",a="p : "+o.id;$("#routesDetails").append('<div class="packInfo"><div>'+i+'</div><div class="packInfo-numbers">'+a+" </div></div>")}),R.initialisePriorityFields(),new F("Adding route",.01).dispatchMessage()}};let U=R;D(U,"allRoutes");let xe=0;const z=class{constructor(t,e,o,i,a,r,l,n,c=[]){this.id=xe++,this.label=t,this.w=parseInt(e*w),this.h=parseInt(o*w),this.l=parseInt(i*w),this.q=parseInt(a),this.v=this.w*this.h*this.l,this.stackingCapacity=parseInt(r),this.rotations=l,this.dimensions=this.setDimensions(l),this.priority=parseInt(n),this.color=Math.random(),this.multiplePrio=c.length>0,this.subQuantities=c,z.allInstances.push(this.getPack)}get getPack(){return{id:this.id,label:this.label,w:this.w,h:this.h,l:this.l,q:this.q,v:this.v,priority:this.priority,stackC:this.stackingCapacity,rotations:this.dimensions,rotateDirections:this.rotations,multiplePrio:this.multiplePrio,subQuantities:this.subQuantities,color:this.color}}get getPackToLocalStorage(){return{label:this.label,w:this.w/w,h:this.h/w,l:this.l/w,q:this.q,priority:this.priority,stackC:this.stackingCapacity,rotations:this.rotations,subQuantities:this.subQuantities}}setDimensions(t){let e=[];for(let i=0;i<t.length;i++){let a=t[i];a=="base"&&e.push({w:this.w,h:this.h,l:this.l,type:[a,0],surface:this.w*this.l},{w:this.l,h:this.h,l:this.w,type:[a,90],surface:this.w*this.l}),a=="right-side"&&e.push({w:this.w,h:this.l,l:this.h,type:[a,0],surface:this.w*this.h},{w:this.h,h:this.l,l:this.w,type:[a,90],surface:this.w*this.h}),a=="front-side"&&e.push({w:this.h,h:this.w,l:this.l,type:[a,0],surface:this.h*this.l},{w:this.l,h:this.w,l:this.h,type:[a,90],surface:this.h*this.l})}e.sort((i,a)=>a.surface-i.surface);for(let i=0;i<e.length;i+=2)if(e[i].l>e[i].w){var o=e[i+1];e[i+1]=e[i],e[i]=o}return e}static init(){localStorage.getItem("packages")!==null&&(JSON.parse(localStorage.getItem("packages")).forEach(e=>{new z(e.label,e.w,e.h,e.l,e.q,e.stackC,e.rotations,e.priority,e.subQuantities)}),z.allInstances.forEach(e=>{var o=e.w/w+" , "+e.h/w+" , "+e.l/w+" ( "+e.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+e.label+'</div><div class="packInfo-numbers">'+o+" </div></div>")}))}add(){var t=[];localStorage.getItem("packages")!==null&&(t=JSON.parse(localStorage.getItem("packages"))),t.push(this.getPackToLocalStorage),localStorage.setItem("packages",JSON.stringify(t)),z.loadPacks(),new F("Adding Pack",.01).dispatchMessage()}static updatePackLocalstorage(){localStorage.removeItem("packages");let t=[];z.allInstances.map(e=>{t.push({label:e.label,w:parseFloat(e.w/w),h:parseFloat(e.h/w),l:parseFloat(e.l/w),q:parseInt(e.q),priority:e.priority,stackC:parseInt(e.stackC),rotations:e.rotateDirections,multiplePrio:e.subQuantities.length>0,subQuantities:e.subQuantities})}),localStorage.setItem("packages",JSON.stringify(t))}static update(t,e){function o(c,s,u,h){let d=[];for(let y=0;y<c.length;y++){let m=c[y];m=="base"&&d.push({w:s,h:u,l:h,type:[m,0],surface:s*h},{w:h,h:u,l:s,type:[m,90],surface:s*h}),m=="right-side"&&d.push({w:s,h,l:u,type:[m,0],surface:s*u},{w:u,h,l:s,type:[m,90],surface:s*u}),m=="front-side"&&d.push({w:u,h:s,l:h,type:[m,0],surface:u*h},{w:h,h:s,l:u,type:[m,90],surface:u*h})}d.sort((y,m)=>m.surface-y.surface);for(let y=0;y<d.length;y+=2)if(d[y].l>d[y].w){var x=d[y+1];d[y+1]=d[y],d[y]=x}return d}let i=z.allInstances.findIndex(c=>c.id==parseInt(e)),a=z.allInstances[i],r={label:t.label,w:parseInt(t.w),h:parseInt(t.h),l:parseInt(t.l),q:parseInt(t.q),priority:parseInt(t.priority),v:t.w*t.h*t.l,stackC:parseInt(t.stack),rotateDirections:t.r,rotations:o(t.r,parseInt(t.w),parseInt(t.h),parseInt(t.l)),multiplePrio:t.subQuantities.length>0,subQuantities:t.subQuantities},l=L(L({},a),r);z.allInstances[i]=l,z.removePacksFromTheScene(),z.updatePackLocalstorage(),$("#packageDetails").empty(),z.allInstances.forEach(c=>{var s=c.w/w+" , "+c.h/w+" , "+c.l/w+" ( "+c.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+c.label+'</div><div class="packInfo-numbers">'+s+" </div></div>")}),new F("Updating Pack",.01).dispatchMessage()}static remove(t){let e=z.allInstances.findIndex(i=>i.id==parseInt(t));z.allInstances.splice(e,1),z.removePacksFromTheScene(),z.updatePackLocalstorage(),$("#packageDetails").empty(),z.allInstances.forEach(i=>{var a=i.w/w+" , "+i.h/w+" , "+i.l/w+" ( "+i.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+i.label+'</div><div class="packInfo-numbers">'+a+" </div></div>")}),new F("Remove Pack",.01).dispatchMessage()}static loadPacks(){function t(c){var s=c.w/w+" , "+c.h/w+" , "+c.l/w+" ( "+c.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+c.label+'</div><div class="packInfo-numbers">'+s+" </div></div>")}z.removeBoxesFromTheScene(),$("#packageDetails div").remove();let e=z.allInstances,o=new f.Group;o.name="pack_shower",e.sort((c,s)=>s.v-c.v);var i,a,r;let l=-300,n=400;for(let c=0;c<e.length;c++){let s=e[c];a=new f.BoxGeometry(s.w,s.h,s.l),r=new f.MeshLambertMaterial({color:s.color*16715775,side:f.DoubleSide}),i=new f.Mesh(a,r),i.castShadow=!0,i.receiveShadow=!0,i.userData.id=s.id,i.userData.hover=!0,i.userData.dragDrop=!0,i.userData.clickable=!0,i.userData.actif=!1,i.userData.name="Pack",c!=0?i.position.set(l,-110-.1,n):i.position.set(l,-65,n),l+=s.w+20,l>800&&(n+=400,l=-300),a.translate(s.w/2,s.h/2,s.l/2),o.add(i),t(s)}v.add(o)}static loadPacksFromLocalStorage(){z.init(),z.loadPacks()}static removePacksFromTheScene(){v.remove(v.getObjectByName("All_Packs"))}static removeBoxesFromTheScene(){v.remove(v.getObjectByName("pack_shower"))}};let I=z;D(I,"allInstances",[]);const A=class{constructor(t,e,o){this.width=parseInt(t*w),this.height=parseInt(e*w),this.lenght=parseInt(o*w),A.dragSurface=this.getDragSurface}get getDragSurface(){return{width:this.width,height:this.height,lenght:this.lenght}}static switch(t){A.draggerStat=t}};let O=A;D(O,"draggerStat",!1),D(O,"dragSurface",{});const ee=class{constructor(t,e){this.object=t,this.parent_id=e,this.packDetails=I.allInstances.find(o=>o.id==e),this.q=this.packDetails.q,this.stat={dimensions:{w:this.packDetails.w,h:this.packDetails.h,l:this.packDetails.l},position:this.object.position},ee.allDraggableItems.push(this.getItem)}get getItem(){return{object:this.object,parent_id:this.parent_id,packDetails:this.packDetails,q:this.q,stat:this.stat}}bestPosition(t){let e=O.dragSurface;if(C.openPoints.length==0)return{x:0,y:0,z:0};for(let o=0;o<C.openPoints.length;o++){let i=C.openPoints[o];if(i.z+t.l<=e.lenght&&i.y+t.h<=e.height&&i.x+t.w<=e.width)return i}}createDragItem(t){let e=this.checkQuantityItem(this.parent_id,this.q);if(e!=-1){let o=I.allInstances.filter(u=>u.id==this.parent_id)[0],i=new f.Group;i.name="Box_Border_"+this.parent_id,i.userData.parent_id=this.parent_id,i.userData.id=this.parent_id+"-"+e;let a=new f.MeshLambertMaterial({color:o.color*16715775,side:f.DoubleSide}),r=new f.BoxGeometry(o.w,o.h,o.l),l=new f.Mesh(r,a);l.userData.parent_id=this.parent_id,l.userData.id=this.parent_id+"-"+e;let n=new f.EdgesGeometry(r),c=new f.LineSegments(n,new f.LineBasicMaterial({color:16777215}));c.name="Line_"+this.parent_id,c.userData.id=this.parent_id,c.userData.name="Line";let s=this.bestPosition(o);return this.stat.position=s,i.position.set(s.x,s.y,s.z),r.translate(o.w/2,o.h/2,o.l/2),n.translate(o.w/2,o.h/2,o.l/2),i.add(l),i.add(c),v.add(i),t.attach(i),l}return!1}checkQuantityItem(t,e){let o=C.loadedPack.filter(i=>i.box.userData.parent_id==t);return C.loadedPack.length==0?0:e-o.length>0?o.length:-1}};let J=ee;D(J,"allDraggableItems",[]);const p=class{constructor(){this.transformControl}start(t,e){this.transformControl=new fe(B,N.domElement),this.transformControl.setSpace("local"),this.transformControl.setRotationSnap(Math.PI/2),v.add(this.transformControl),this.transformControl.addEventListener("dragging-changed",function(a){T.enabled=!a.value});let o=new J(t,e);p.item=o.getItem;let i=o.createDragItem(this.transformControl);i!=!1&&(this.dragging(i),p.specificOpenPoints=[],p.currentPos=p.item.stat.position,p.filterOpenPointByPackage())}dragging(t){let e=this.transformControl;function o(){if(e!=null){let s=p.item.stat.dimensions,u=p.item.stat.position,h=new f.BoxGeometry(s.w,s.h,s.l),d=new f.EdgesGeometry(h);h.translate(s.w/2,s.h/2,s.l/2),d.translate(s.w/2,s.h/2,s.l/2),e.object.children[0].geometry=h,e.object.children[1].geometry=d,e.object.position.set(u.x,u.y,u.z)}}function i(){if(e!=null){let s=e.object.children[0],u=s.geometry.parameters,h=s.userData.id;p.loadedPack.push({id:t.userData.id,parent_id:t.userData.parent_id,w:u.width,h:u.height,l:u.depth,x:p.currentPos.x,y:p.currentPos.y,z:p.currentPos.z,box:t}),p.openPoints.push({pointOwner:h,x:p.currentPos.x,y:p.currentPos.y,z:p.currentPos.z+u.depth,type:"R"},{pointOwner:h,x:p.currentPos.x,y:p.currentPos.y+u.height,z:p.currentPos.z,type:"T"},{pointOwner:h,x:p.currentPos.x+u.width,y:p.currentPos.y,z:p.currentPos.z,type:"F"});let d=p.openPoints.findIndex(m=>m.x==p.currentPos.x&&m.y==p.currentPos.y&&m.z==p.currentPos.z);c(d),p.openPoints.sort((m,k)=>m.x-k.x||m.z-k.z||m.y-k.y),v.remove(v.getObjectByName("sphere"));let x=new f.Group;x.name="sphere",p.openPoints.forEach(m=>{const k=new f.SphereGeometry(3,32,16),M=new f.MeshBasicMaterial({color:16776960}),P=new f.Mesh(k,M);P.position.set(m.x,m.y,m.z),x.add(P)}),v.add(x);let y=new f.Group;y.name="sphere",p.specificOpenPoints.forEach(m=>{const k=new f.SphereGeometry(3,32,16),M=new f.MeshBasicMaterial({color:16777215}),P=new f.Mesh(k,M);P.position.set(m.x,m.y,m.z),y.add(P)}),v.add(y),e.detach(),e=null,a(t.userData.parent_id)}}function a(s){let u=p.loadedPack.filter(h=>h.box.userData.parent_id==s);if(p.item.q-u.length==0){console.log(u);let d=v.getObjectByName("pack_shower").children.find(x=>x.userData.id==u[0].box.userData.parent_id);d.material.transparent=!0,d.material.opacity=.6,d.userData.dragDrop=!1}}function r(){let s=p.currentPos,u=p.specificOpenPoints.find(d=>d.x==s.x&&d.y==s.y&&d.z==s.z);console.log(u);let h=u.rotations.findIndex(d=>d.type[0]==p.currentRotation.face&&d.type[1]==p.currentRotation.yAxis);if(console.log(h),h!=-1){let d=u.rotations[h],x=new f.BoxGeometry(d.w,d.h,d.l),y=new f.EdgesGeometry(x);x.translate(d.w/2,d.h/2,d.l/2),y.translate(d.w/2,d.h/2,d.l/2),e!=null&&(e.object.children[0].geometry=x,e.object.children[1].geometry=y,p.currentRotation={face:u.rotations[++h%u.rotations.length].type[0],yAxis:u.rotations[h%u.rotations.length].type[1]})}}function l(s){let u=p.specificOpenPoints.find(y=>y.x==s.x&&y.y==s.y&&y.z==s.z),h=u.rotations[0],d=new f.BoxGeometry(h.w,h.h,h.l),x=new f.EdgesGeometry(d);d.translate(h.w/2,h.h/2,h.l/2),x.translate(h.w/2,h.h/2,h.l/2),e!=null&&(e.object.children[0].geometry=d,e.object.children[1].geometry=x,p.currentRotation={face:u.rotations[0].type[0],yAxis:u.rotations[0].type[1]})}function n(s){const u=(d,x)=>Math.sqrt((x.x-d.x)**2+(x.y-d.y)**2+(x.z-d.z)**2),h=(d,x,y=1e-5)=>{const m=x.map(M=>u(d,M)),k=Math.min(...m);return x.find((M,P)=>m[P]-k<y)};return p.openPoints.length==1?h(s,p.openPoints):h(s,p.specificOpenPoints)}function c(s){function u(d){return d.filter((x,y,m)=>m.findIndex(k=>k.x===x.x&&k.y===x.y&&k.z===x.z)===y)}function h(){let d=p.loadedPack[p.loadedPack.length-1];for(let y=p.openPoints.length-1;y>=0;y--){let m=p.openPoints[y];(O.width==m.x||O.height==m.y||O.lenght==m.z)&&p.openPoints.splice(y,1)}let x=[];p.openPoints.map((y,m)=>{y.x+1>=d.x&&y.x+1<=d.x+d.w&&y.z+1>=d.z&&y.z+1<=d.z+d.l&&y.y==d.y&&y.pointOwner!=d.id&&x.push(m)}),x.sort((y,m)=>m-y);for(let y=0;y<x.length;y++)console.log(p.openPoints[x[y]]),p.openPoints.splice(x[y],1);for(let y=0;y<p.openPoints.length;y++){let m=p.openPoints[y],k=m.pointOwner.split("-")[0];for(let M=y+1;M<p.openPoints.length;M++){let P=p.openPoints[M],G=P.pointOwner.split("-")[0];if(m.x==P.x&&m.y==P.y&&m.type!="S"&&k==G){let W=p.loadedPack.filter(b=>m.y==0?b.y==m.y&&b.x>m.x&&b.z<=m.z&&b.z+b.l>=m.z:b.y+b.h==m.y&&b.x<=m.x+1&&b.x+b.w>=m.x+1&&b.z<=m.z+1&&b.z+b.l>=m.z+1),Q=p.loadedPack.filter(b=>P.y==0?b.y==P.y&&b.x>P.x&&b.z<=P.z&&b.z+b.l>=P.z:b.y+b.h==P.y&&b.x<=P.x+1&&b.x+b.w>=P.x+1&&b.z<=P.z+1&&b.z+b.l>=P.z+1);W.length!=0&&Q.length!=0&&Math.abs(W[0].x-m.x)==Math.abs(Q[0].x-P.x)&&p.openPoints.splice(M,1),W.length==0&&Q.length==0&&p.openPoints.splice(M,1)}m.x==P.x&&m.z==P.z&&k==G&&p.openPoints.splice(M,1),m.y==P.y&&m.z==P.z&&!m.ignored&&k==G&&P.type!="S"&&p.openPoints.splice(M,1)}}}s!=-1&&p.openPoints.splice(s,1),p.openPoints=u(p.openPoints),p.openPoints.sort((d,x)=>d.x-x.x||d.z-x.z||d.y-x.y),h()}e.addEventListener("mouseUp",function(s){let u=e.object,h=s.target.children[1].position,d=n(h);u.position.set(d.x,d.y,d.z),l(d),p.currentPos=d}),document.addEventListener("keydown",function(s){switch(s.key.toUpperCase()){case"DELETE":v.remove(e.object),e.detach(),e=null;break;case"SHIFT":e.setTranslationSnap(100),e.setRotationSnap(Math.PI/2),e.setScaleSnap(.25);break;case"W":e.setMode("translate");break;case"E":e.setMode("rotate");break;case"R":e.setMode("scale");break;case"+":case"=":e.setSize(e.size+.1);break;case"-":case"_":e.setSize(Math.max(e.size-.1,.1));break;case"X":e.showX=!e.showX;break;case"Y":e.showY=!e.showY;break;case"Z":e.showZ=!e.showZ;break;case" ":e.enabled=!e.enabled;break;case"ESCAPE":o();break;case"ENTER":i();break;case"F":r();break;default:console.log("this key don't support any action")}})}static filterOpenPointByPackage(){function t(a){a.geometry.computeBoundingBox(),a.updateMatrixWorld();let r=a.geometry.boundingBox.clone();r.applyMatrix4(a.matrixWorld),r.max.x=r.max.x-1,r.max.y=r.max.y-1,r.max.z=r.max.z-1,r.min.x=r.min.x+1,r.min.y=r.min.y+1,r.min.z=r.min.z+1;for(let l=0;l<p.loadedPack.length;l++){let n=p.loadedPack[l].box;n.geometry.computeBoundingBox(),n.updateMatrixWorld();let c=n.geometry.boundingBox.clone();c.applyMatrix4(n.matrixWorld),console.log(r,c,r.intersectsBox(c))}return!1}let e=[],o=O.dragSurface,i;if(p.openPoints.length==1){let a=p.item.packDetails.rotations;i=[];for(let r=0;r<a.length;r++){let l=a[r];l.w<=o.width&&l.h<=o.height&&l.l<=o.lenght&&!t(p.item.object)&&i.push(j(L({},l),{type:[l.type[0],l.type[1]*(Math.PI/180)]}))}i.length>0&&e.push({id:"c-0",type:"O",x:0,y:0,z:0,rotations:i})}for(let a=0;a<p.openPoints.length;a++){let r=p.openPoints[a],l=p.item.packDetails.rotations;i=[];for(let n=0;n<l.length;n++){let c=l[n];c.w+r.x<=o.width&&c.h+r.y<=o.height&&c.l+r.z<=o.lenght&&!t(p.item.object)&&i.push(j(L({},c),{type:[c.type[0],c.type[1]*(Math.PI/180)]}))}i.length>0&&e.push({id:r.pointOwner,type:r.type,x:r.x,y:r.y,z:r.z,rotations:i})}p.specificOpenPoints=e,console.log(p.specificOpenPoints)}};let C=p;D(C,"loadedPack",[]),D(C,"openPoints",[{x:0,y:0,z:0}]),D(C,"specificOpenPoints",[]),D(C,"currentPos",null),D(C,"currentRotation",{face:"base",yAxis:0}),D(C,"item",{}),D(C,"lastKeyPressed");const ae=new f.Raycaster,V=new f.Vector2;function Z(g){V.x=(g.clientX-S.offsetLeft)/S.offsetWidth*2-1,V.y=-((g.clientY-S.offsetTop)/S.offsetHeight)*2+1,ae.setFromCamera(V,B);var t;return v.getObjectByName("pack_shower")&&(t=ae.intersectObjects(v.getObjectByName("pack_shower").children),t.length>0&&t[0].object.userData.clickable)?t:!1}function we(g){O.draggerStat?Pe(g):ve(g)}function ve(g){console.log("clicked");let t=Z(g);if(t!=!1){let o=t[0].object.userData.id;ze(o),Ie(o)}}function Pe(g){console.log("mousePressed");let t=Z(g);if(t!=!1){let e=t[0].object,o=e.userData.id;e.userData.dragDrop&&new C().start(e,o)}}function be(g){let t=Z(g);t!=!1?t[0].object.userData.hover&&(document.body.style.cursor="pointer"):document.body.style.cursor=""}function ze(g){var t;console.log("changing"),v.traverse(e=>{(e.userData.name==="Pack"||e.userData.name=="Line")&&e.userData.id==g&&(t=e.userData.actif)}),v.traverse(e=>{(e.userData.name==="Pack"||e.userData.name=="Line")&&(t?(e.material.transparent=!1,e.material.opacity=1,e.userData.actif=!1,e.castShadow=!0):(e.userData.id==g&&(e.userData.actif=!0,e.material.transparent=!1,e.material.opacity=1,e.castShadow=!0),e.userData.id!=g&&(e.userData.actif=!1,e.material.transparent=!0,e.material.opacity=.2,e.castShadow=!1)))})}function Ie(g){["base","right-side","front-side"].forEach(e=>{$(`#pack_Detail_${e}`).prop("checked",!1)});var t=I.allInstances.find(e=>e.id==g);$("#pack_Detail_Id").val(t.id),$("#pack_Detail_Label").val(t.label),$("#pack_Detail_Width").val(t.w/w),$("#pack_Detail_Height").val(t.h/w),$("#pack_Detail_Lenght").val(t.l/w),$("#pack_Detail_Quantity").val(t.q),$("#pack_Detail_StackingCapacity").val(t.stackC),$("#pack_Detail_Priority").val(t.priority).change(),t.rotateDirections.forEach(e=>{$(`#pack_Detail_${e}`).prop("checked",!0)}),$("#multiple-prio div").remove();for(let e=0;e<t.subQuantities.length;e++){let o=t.subQuantities[e];$("#multiple-prio").append('<div class="sub-content" id="advOptionsPrio'+e+'"><div class="sub-content-inputs"><div><p class="inputLabel">Quantity</p><input type="number" min="1" value="'+o.n+'"class="sub-q input"></div><div><p class="inputLabel">Priority</p><input type="number" min="1" value="'+o.p+'" class="sub-prio input"></div></div><div><i class="fa-solid fa-trash removePrioInput" data="'+e+'"></i></div></div>')}t.loaded!=null&&t.unloaded!=null&&$("#packStatut").html(" ("+t.loaded+" / "+(t.loaded+t.unloaded)+") ")}var B,N,T,X,Y;const ke=new pe;$e();se();Se();function $e(){const t=S.clientWidth/S.clientHeight,e=1,o=1e4;B=new f.PerspectiveCamera(60,t,e,o),B.position.set(1e3,400,800),v.background=new f.Color(16777215),v.fog=new f.FogExp2(9024235,2e-6),Me(),Ce(),Le();let i=new f.DirectionalLight(16777215,.8);i.position.set(120,1e3,-150),i.castShadow=!0,i.shadow.bias=-.001,i.shadow.mapSize.width=4096,i.shadow.mapSize.height=4096,i.shadow.camera.near=.5,i.shadow.camera.far=3e3,i.shadow.camera.left=3e3,i.shadow.camera.right=-3e3,i.shadow.camera.top=1e3,i.shadow.camera.bottom=-1e3,v.add(i),N=new f.WebGLRenderer({antialias:!0}),N.setPixelRatio(window.devicePixelRatio),N.setSize(S.clientWidth,S.clientHeight),N.shadowMap.enabled=!0,S.appendChild(N.domElement),T=new de(B,N.domElement),T.enableDamping=!0,T.minDistance=100,T.maxDistance=3e3,T.enablePan=!1,T.maxPolarAngle=Math.PI/2,T.minPolarAngle=-Math.PI/2,T.update(),window.addEventListener("resize",oe),S.addEventListener("mousemove",be),S.addEventListener("pointerdown",we),ne!=null&&ne.addEventListener("mouseenter",oe)}function oe(){B.aspect=S.clientWidth/S.clientHeight,B.updateProjectionMatrix(),N.setSize(S.clientWidth,S.clientHeight)}function se(){requestAnimationFrame(se),T.update(),De()}function De(){N.render(v,B)}function E(g){return new Promise((t,e)=>{ke.load(g,o=>t(o),null,e)})}async function Se(){const g=new Date().getTime(),t=await E("models/lift_truck/scene.gltf"),e=await E("models/pallet_truck/scene.gltf"),o=await E("models/truck/truck-wheels.gltf"),i=await E("models/truck/truck-support.gltf");_(t.scene,{x:300,y:300,z:300},{x:-250,y:-90,z:450},-Math.PI,!0),_(e.scene,{x:1/2,y:1/2,z:1/2},{x:-450,y:-25,z:700},-Math.PI,!0),_(o.scene,{x:3/2,y:2,z:3/2},{},Math.PI/2,!1),_(i.scene,{x:2,y:2.4,z:2},{},Math.PI/2,!1),X=o.scene,Y=i.scene;const a=new Date().getTime();new F("Chargement des models, styles, ...",(a-g)*Math.pow(10,-3)).dispatchMessage(),$(".threeD-container-loader").toggleClass("threeD-container-loader--show threeD-container-loader--hide")}function _(g,t,e,o,i){let a=g.getObjectByName("holders");(a!=null||a!=null)&&a.translateZ(10),g.scale.set(t.x,t.y,t.z),g.rotation.y=o,g.traverse(function(r){r.isMesh&&(r.castShadow=!0,r.receiveShadow=!0)}),i&&(g.position.set(e.x,e.y,e.z),v.add(g))}function Me(){const g=new f.TextureLoader,t=g.load("textures/ground/Concrete_019_BaseColor.jpg"),e=g.load("textures/ground/Concrete_019_Normal.jpg"),o=g.load("textures/ground/Concrete_019_Height.png"),i=g.load("textures/ground/Concrete_019_Roughness.jpg"),a=g.load("textures/ground/Concrete_019_AmbientOcclusion.jpg"),r=1800,l=1800,n=6,c=6,s=new f.PlaneGeometry(r,l,10,10),u=new f.MeshStandardMaterial({map:t,normalMap:e,displacementMap:o,displacementScale:.3,roughnessMap:i,roughness:1,aoMap:a});for(let h=0;h<n;h++)for(let d=0;d<c;d++){const x=new f.Mesh(s,u);x.castShadow=!1,x.receiveShadow=!0,x.rotation.x=-Math.PI/2,x.position.y=-110,x.position.x=h*r-n/2*r,x.position.z=d*l-c/2*l,v.add(x)}}function Ce(){const g=`
  varying vec3 vWorldPosition;
  void main() {
    vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
    vWorldPosition = worldPosition.xyz;
    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
  }`,t=`
  uniform vec3 topColor;
  uniform vec3 bottomColor;
  uniform float offset;
  uniform float exponent;
  varying vec3 vWorldPosition;
  void main() {
    float h = normalize( vWorldPosition + offset ).y;
    gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h , 0.0), exponent ), 0.0 ) ), 1.0 );
  }`,e=new f.HemisphereLight(16777215,268435455,.6);e.color.setHSL(.6,1,.6),e.groundColor.setHSL(.095,1,.75),v.add(e);const o={topColor:{value:new f.Color(30719)},bottomColor:{value:new f.Color(16777215)},offset:{value:33},exponent:{value:.6}};o.topColor.value.copy(e.color),v.fog.color.copy(o.bottomColor.value);const i=new f.SphereBufferGeometry(4e3,32,15),a=new f.ShaderMaterial({uniforms:o,vertexShader:g,fragmentShader:t,side:f.BackSide}),r=new f.Mesh(i,a);v.add(r)}function Le(){$(".cube__face").click(function(){let g=$(this).attr("role");g=="front"&&gsap.to(B.position,{duration:1,x:2e3,y:100,z:0,ease:"power3.inOut"}),g=="left"&&gsap.to(B.position,{duration:1,x:0,y:200,z:2e3,ease:"power3.inOut"}),g=="top"&&gsap.to(B.position,{duration:1,x:2e3,y:1e3,z:1200,ease:"power3.inOut"})})}function Oe(){v.remove(v.getObjectByName("Full_Container")),v.remove(v.getObjectByName("All_Packs")),$("#result").empty()}$(document).ready(function(){$(".menuIcon").click(function(){$(".menu").toggleClass("openMenu closeMenu"),$(".menuIcon").toggleClass("openMenuIcon closeMenu")}),$("#closeMenuIcon").click(function(){$(".menu").toggleClass("openMenu closeMenu"),$(".menuIcon").toggleClass("openMenuIcon closeMenu")}),$("#reset").click(function(){localStorage.removeItem("container"),localStorage.removeItem("packages"),location.reload()});let g=!1;$("#switchManuelleMode").click(function(){g=!g,$("#switchManuelleMode i").toggleClass("fa-hand-back-fist fa-hand"),O.switch(g)}),$("#openCSV").click(function(){$("#openCSV").toggleClass("fa-circle-plus fa-circle-minus"),$("#csv").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openApi").click(function(){$("#openApi").toggleClass("fa-circle-plus fa-circle-minus"),$("#api").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openRoutes").click(function(){$("#openRoutes").toggleClass("fa-circle-plus fa-circle-minus"),$("#routes").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openPackages").click(function(){$("#openPackages").toggleClass("fa-circle-plus fa-circle-minus"),$("#packages").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openVehicule").click(function(){$("#openVehicule").toggleClass("fa-circle-plus fa-circle-minus"),$("#vehicule").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openResult").click(function(){$("#openResult").toggleClass("fa-circle-plus fa-circle-minus"),$("#result").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openPackDetail").click(function(){$("#openPackDetail").toggleClass("fa-circle-plus fa-circle-minus"),$("#packDetail").toggleClass("pack-detail-close pack-detail-open")});var t=JSON.parse(localStorage.getItem("container"));if(t!==null){var e=t.w+" , "+t.h+" , "+t.l;$("#containerDetails").append("<span>"+e+"</span>")}$("#toggleAdvParam").click(function(){$(".sub-container").toggleClass("sub-container--close sub-container--open"),$("#toggleAdvParam").toggleClass("toggleAdvParam--close toggleAdvParam--open")});let o=0;$("#addPrioInputs").click(function(){let r=$("#pack_Detail_Quantity").val();if(r!=""&&r>1){let n=i(".sub-q").reduce((s,u)=>s=s+u,0),c=r-n;c>0?(a(".sub-q"),$("#multiple-prio").append('<div class="sub-content" id="advOptionsPrio'+o+'"><div class="sub-content-inputs"><div><p class="inputLabel">Quantity</p><input type="number" min="1" max="'+c+'" value="'+c+'"class="sub-q input"></div><div><p class="inputLabel">Priority</p><input type="number" min="0" class="sub-prio input"></div></div><div><i class="fa-solid fa-trash removePrioInput" data="'+o+++'"></i></div></div>'),$(".sub-container").animate({scrollTop:$(".sub-container").prop("scrollHeight")},500)):alert("the somme is bigger than initial quantity")}else alert("the initial quantity is empty or less than 1 Or the somme is bigger than initial quantity")}),$(document).on("click",".removePrioInput",function(){$("#advOptionsPrio"+$(this).attr("data")).remove()});function i(r){let l=$(r),n=[];for(let c=0;c<l.length;c++){let s=l[c];n.push(parseInt(s.value))}return n}function a(r){let l=$(r);l.length>=1&&(console.log(l[l.length-1],l[l.length-1].disabled),l[l.length-1].disabled="disabled")}});const te=class{constructor(t,e,o,i){this.w=parseInt(t*w),this.h=parseInt(e*w),this.l=parseInt(o*w),this.capacity=parseInt(i),this.loadContainer(),te.instances=this.getContainer}get getContainer(){return{w:this.w,h:this.h,l:this.l,capacity:this.capacity}}get getContainerLocalStorage(){return{w:this.w/w,h:this.h/w,l:this.l/w,capacity:this.capacity}}loadContainer(){var t=new f.MeshLambertMaterial({color:9737364,side:f.DoubleSide}),e=new f.MeshLambertMaterial({color:9737364,side:f.DoubleSide,transparent:!0,opacity:.5}),o,i=new f.Group;i.name="Full_Container";const a=new f.BoxGeometry(this.w+5,5,this.l+5),r=new f.BoxGeometry(this.w+5,this.h,5),l=new f.BoxGeometry(5,this.h,this.l);a.translate(this.w/2-5/2,-5/2-.1,this.l/2-5/2),r.translate(this.w/2-5/2,this.h/2,-5/2-.1),l.translate(-5/2-.1,this.h/2,this.l/2),o=new f.Mesh(a,t),i.add(o),o.castShadow=!0,o.receiveShadow=!0,o=new f.Mesh(r,e),i.add(o),o=new f.Mesh(l,e),i.add(o),this.loadTruck(this.w,this.l,i);var n=this.w/w+" , "+this.h/w+" , "+this.l/w;$("#containerDetails").html("<span>"+n+"</span>"),$("#containerWidth").val(this.w/w),$("#containerHeight").val(this.h/w),$("#containerLenght").val(this.l/w),$("#containerUnloading").val(this.unloading),localStorage.setItem("container",JSON.stringify(this.getContainerLocalStorage)),new F("Loading container",.01).dispatchMessage()}loadTruck(t,e,o){X.position.set(t-440,-110,e/2),Y.position.set(400,-110,e/2),o.add(X),o.add(Y),v.add(o)}};let q=te;D(q,"instances");class Fe{constructor(t){D(this,"isPointContainedInSpace",(t,e,o)=>o?e.x>t[0].x&&e.x<=t[3].x&&e.z>t[0].z&&e.z<=t[3].z:e.x>=t[0].x&&e.x<=t[3].x&&e.z>=t[0].z&&e.z<=t[3].z);this.algorithm=t,this.packagesLoaded=[],this.openPoints=[{x:0,y:0,z:0}],this.boxes=[]}initialisePackagesToLoad(){var t,e=[],o=[];I.allInstances.map(a=>{if(a.multiplePrio){let l=0;for(let n=0;n<a.subQuantities.length;n++){let c=a.subQuantities[n];console.log(c);for(let s=0;s<c.n;s++)t=j(L({},a),{priority:c.p,w:a.rotations[0].w,h:a.rotations[0].h,l:a.rotations[0].l,id:a.id+"-"+l++,parent_id:a.id}),delete t.q,e.push(t)}}else for(var r=0;r<a.q;r++)t=j(L({},a),{w:a.rotations[0].w,h:a.rotations[0].h,l:a.rotations[0].l,id:a.id+"-"+r,parent_id:a.id}),delete t.q,e.push(t)}),console.log(e);let i=e.reduce((a,r)=>{const l=r.priority;return a[l]==null&&(a[l]=[]),a[l].push(r),a},{});return Object.entries(i).forEach(([a,r])=>{o.push(parseInt(a)),r.sort((l,n)=>n.v-l.v)}),o.sort((a,r)=>a-r),[i,o]}getDownPack(t,e,o){return t==-1||t.parent_id!=o?e:(t=this.getPackByTopCoords({x:t.x,y:t.y,z:t.z}),e++,this.getDownPack(t,e,o))}getPackByTopCoords(t){return this.packagesLoaded.filter(o=>o.openPoint.T.x==t.x&&o.openPoint.T.y==t.y&&o.openPoint.T.z==t.z)[0]||-1}canBeStacked(t,e){let o=this.getPackByOpenPoint(e);return o.parent_id==t.parent_id?this.getDownPack(o,0,t.parent_id)<=t.stackC:!0}create2dSpace(t){let e=this.packagesLoaded.filter(i=>(t.y>0?i.y+i.h:i.y)==t.y),o=[];return e.forEach(i=>{o[i.id]==null&&(o[i.id]=[]),o[i.id].push({x:i.x,z:i.z},{x:i.x+i.w,z:i.z},{x:i.x,z:i.z+i.l},{x:i.x+i.w,z:i.z+i.l})}),[e,o]}canFitAboveTheBoxNewVersion(t,e){let o=[{x:e.x,z:e.z},{x:(3*e.x+(e.x+t.w))/4,z:e.z},{x:(e.x+(e.x+t.w))/2,z:e.z},{x:(e.x+3*(e.x+t.w))/4,z:e.z},{x:e.x+t.w,z:e.z},{x:e.x,z:(e.z+3*(e.z+t.l))/4},{x:e.x,z:(e.z+(e.z+t.l))/2},{x:e.x,z:(3*e.z+(e.z+t.l))/4},{x:e.x,z:e.z+t.l},{x:(e.x+3*(e.x+t.w))/4,z:e.z+t.l},{x:(e.x+(e.x+t.w))/2,z:e.z+t.l},{x:(3*e.x+(e.x+t.w))/4,z:e.z+t.l},{x:e.x+t.w,z:e.z+t.l},{x:e.x+t.w,z:(e.z+3*(e.z+t.l))/4},{x:e.x+t.w,z:(e.z+(e.z+t.l))/2},{x:e.x+t.w,z:(3*e.z+(e.z+t.l))/4}],i=this.create2dSpace(e),a=i[0],r=i[1],l=0;for(let n=0;n<o.length;n++)for(let c=0;c<a.length;c++){let s=a[c],u=o[n],h=r[s.id];if(this.isPointContainedInSpace(h,u,!1)){l++;break}}return l==16}okRotation(t,e){for(let o=0;o<this.openPoints.length;o++){let i=this.openPoints[o],a=L({},e);if(!(i.y>0&&i.type=="T"&&e.stackC!=-1&&!this.canBeStacked(e,i))){for(let r=0;r<e.rotations.length;r++){let l=e.rotations[r];if(l.l+i.z<=t.l&&l.h+i.y<=t.h&&l.w+i.x<=t.w){let n=this.createTemperoryBox(l,i);if(this.checkCollision(n)||i.y>0&&!this.canFitAboveTheBoxNewVersion(l,i))continue;return a.w=l.w,a.l=l.l,a.h=l.h,a.validRotation=l.type,[i,o,a]}}if(o==this.openPoints.length-1)return!1}}}removeNonWorkingOpenPoints(t){let e=this.packagesLoaded[this.packagesLoaded.length-1];for(let i=this.openPoints.length-1;i>=0;i--){let a=this.openPoints[i];(t.w==a.x||t.h==a.y||t.l==a.z)&&this.openPoints.splice(i,1)}let o=[];this.openPoints.map((i,a)=>{i.x+1>=e.x&&i.x+1<=e.x+e.w&&i.z+1>=e.z&&i.z+1<=e.z+e.l&&i.y==e.y&&i.pointOwner!=e.id&&o.push(a)}),o.sort((i,a)=>a-i);for(let i=0;i<o.length;i++)this.openPoints.splice(o[i],1);for(let i=0;i<this.openPoints.length;i++){let a=this.openPoints[i],r=a.pointOwner.split("-")[0];for(let l=i+1;l<this.openPoints.length;l++){let n=this.openPoints[l],c=n.pointOwner.split("-")[0];if(a.x==n.x&&a.y==n.y&&a.type!="S"&&r==c){let s=this.packagesLoaded.filter(h=>a.y==0?h.y==a.y&&h.x>a.x&&h.z<=a.z&&h.z+h.l>=a.z:h.y+h.h==a.y&&h.x<=a.x+1&&h.x+h.w>=a.x+1&&h.z<=a.z+1&&h.z+h.l>=a.z+1),u=this.packagesLoaded.filter(h=>n.y==0?h.y==n.y&&h.x>n.x&&h.z<=n.z&&h.z+h.l>=n.z:h.y+h.h==n.y&&h.x<=n.x+1&&h.x+h.w>=n.x+1&&h.z<=n.z+1&&h.z+h.l>=n.z+1);s.length!=0&&u.length!=0&&Math.abs(s[0].x-a.x)==Math.abs(u[0].x-n.x)&&this.openPoints.splice(l,1),s.length==0&&u.length==0&&this.openPoints.splice(l,1)}a.x==n.x&&a.z==n.z&&r==c&&this.openPoints.splice(l,1),a.y==n.y&&a.z==n.z&&!a.ignored&&r==c&&n.type!="S"&&this.openPoints.splice(l,1)}}}refreshOpenPoints(t,e){this.openPoints.splice(t,1),this.openPoints=this.removeDuplicatesObjectFromArray(this.openPoints),this.sortOpenPoints(),this.removeNonWorkingOpenPoints(e)}removeDuplicatesObjectFromArray(t){return t.filter((e,o,i)=>i.findIndex(a=>a.x===e.x&&a.y===e.y&&a.z===e.z)===o)}removeOpenPointForNextPriority(){let t=[];if(this.openPoints.map((e,o)=>{e.type=="T"&&t.push({data:e,index:o})}),t.length>0){t.sort((o,i)=>i.data.y-o.data.y);let e=t[0].data.y;t.sort((o,i)=>i.index-o.index);for(let o=t.length-1;o>=0;o--){let i=t[o];console.log(i,e),i.data.y==e&&(console.log(this.openPoints[i.index]),this.openPoints.splice(i.index,1))}}}removePointForNextPriority(t,e){let o=t[e-1]||t[0],i=t[e];console.log(t[e],o);let a=this.openPoints.filter(l=>l.prio>=o&&l.prio<=i&&l.type!="T");console.log(a);let r=[...a];this.openPoints=r}removePointsNextPriority(){this.openPoints=this.openPoints.filter(t=>t.y==0)}getIndexes(t){let e=[];return this.openPoints.map((o,i)=>{parseInt(o.type!=null&&o.type=="T"&&o.pointOwner.split("-")[0])==t.parent_id&&e.push({index:i,data:o})}),e}removeDiagonalPoints(t){let e=this.getIndexes(t),o=[];if(e.length>=2){for(let a=0;a<e.length;a++){let r=e[a];for(let l=a+1;l<e.length;l++){let n=e[l];Math.abs(n.data.z-r.data.z)%t.l==0&&Math.abs(n.data.x-r.data.x)%t.w==0&&r.data.y==n.data.y&&n.data.z>r.data.z&&n.data.x>r.data.x&&o.push(n.index)}}let i=[...new Set(o)];i.sort((a,r)=>r-a),i.map(a=>{this.openPoints.splice(a,1)})}}sortOpenPoints(){this.openPoints.sort((t,e)=>t.x-e.x||t.z-e.z||t.y-e.y)}solve(t,e,o){for(let i=0;i<o.length;i++){let a=e[o[i]];for(let r=0;r<a.length;r++){let l=a[r],n=this.okRotation(t,l);n!==!1&&(this.createPack(n[2],n[0]),this.refreshOpenPoints(n[1],t),this.openPoints.push(...this.createSidePoints()),this.sortOpenPoints(),this.packagesLoaded.length>=2&&this.packagesLoaded[this.packagesLoaded.length-1].parent_id!=this.packagesLoaded[this.packagesLoaded.length-2].parent_id&&this.removeDiagonalPoints(this.packagesLoaded[this.packagesLoaded.length-2]))}this.removePointsNextPriority()}return console.log("packagesLoaded => "),console.log(this.packagesLoaded),console.log("openPoints => "),console.log(this.openPoints),[this.openPoints,this.packagesLoaded]}checkCollision(t){t.geometry.computeBoundingBox(),t.updateMatrixWorld();let e=t.geometry.boundingBox.clone();e.applyMatrix4(t.matrixWorld),e.max.x=e.max.x-1,e.max.y=e.max.y-1,e.max.z=e.max.z-1,e.min.x=e.min.x+1,e.min.y=e.min.y+1,e.min.z=e.min.z+1;for(let o=0;o<this.boxes.length;o++){let i=this.boxes[o];i.geometry.computeBoundingBox(),i.updateMatrixWorld();let a=i.geometry.boundingBox.clone();if(a.applyMatrix4(i.matrixWorld),a.max.x=a.max.x-1,a.max.y=a.max.y-1,a.max.z=a.max.z-1,a.min.x=a.min.x+1,a.min.y=a.min.y+1,a.min.z=a.min.z+1,e.intersectsBox(a))return e.intersectsBox(a)}return!1}createTemperoryBox(t,e){let o=new f.MeshLambertMaterial({color:t.color*16715775,side:f.DoubleSide}),i=new f.BoxGeometry(t.w,t.h,t.l),a=new f.Mesh(i,o),r=new f.Vector3(e.x,e.y,e.z);return a.position.copy(r),i.translate(t.w/2,t.h/2,t.l/2),a}getPackByOpenPoint(t){return this.packagesLoaded.filter(o=>o.id===t.pointOwner)[0]}getPackById(t){return this.packagesLoaded.filter(o=>o.parent_id===t)[0]}createSidePoints(){let t=this.packagesLoaded[this.packagesLoaded.length-1],e=[],o=this.openPoints.filter(a=>a.y==t.y&&a.x<t.x+t.w&&a.pointOwner!=t.id&&a.type!="S"&&!a.ignored);o.sort((a,r)=>a.z-r.z);var i=null;if(o.length>0){if(t.z+t.l-o[0].z>0){let a=t.openPoint.F,r=o[0];if(this.packagesLoaded.filter(n=>n.x>a.x&&n.x<=r.x&&n.z>a.z&&n.z<=r.z&&n.y==a.y).length==0){let n={pointOwner:t.id,x:t.x+t.w,y:t.y,z:o[0].z,type:"S",ignored:!1,prio:t.priority},c=this.packagesLoaded.filter(s=>{if(n.y>0)return s.y+s.h==n.y&&s.x<=n.x+1&&s.x+s.w>=n.x+1&&s.z<=n.z+1&&s.z+s.l>=n.z+1});if(t.y==0){let s=this.packagesLoaded.filter(u=>u.x<=n.x&&u.x+u.w>=n.x&&u.z<=n.z&&u.z+u.l>=n.z);(n.z==0||s.length!=0)&&(e.push(n),i=this.openPoints.findIndex(u=>u.x==o[0].x&&u.y==t.y&&u.z==o[0].z))}else c.length>0&&(e.push(n),i=this.openPoints.findIndex(s=>s.x==o[0].x&&s.y==t.y&&s.z==o[0].z))}}if(t.z+t.l-o[0].z<0){let a=t.openPoint.F,r=o[0];if(this.packagesLoaded.filter(n=>n.x>=r.x&&n.x<=a.x&&n.z+1>a.z&&n.z+1<=r.z&&n.y==a.y).length==0){let n={pointOwner:t.id,x:o[0].x,y:t.y,z:t.z+t.l,type:"S",ignored:!1,prio:t.priority},c=this.packagesLoaded.filter(s=>{if(n.y>0)return s.y+s.h==n.y&&s.x<=n.x+1&&s.x+s.w>=n.x+1&&s.z<=n.z+1&&s.z+s.l>=n.z+1});if(t.y==0){let s=this.packagesLoaded.filter(u=>u.x<=n.x&&u.x+u.w>=n.x&&u.z<=n.z&&u.z+u.l>=n.z);(n.z==0||s.length!=0)&&(e.push(n),i=this.openPoints.findIndex(u=>u.x==t.x&&u.y==t.y&&u.z==t.z+t.l))}else c.length>0&&(e.push(n),i=this.openPoints.findIndex(s=>s.x==t.x&&s.y==t.y&&s.z==t.z+t.l))}}i!=-1&&i!=null&&(this.openPoints[i].ignored=!0)}return e}createOpenPoints(t,e){let o=[{pointOwner:e.id,x:t.x,y:t.y+e.h,z:t.z,type:"T",ignored:!1,prio:e.priority}],i=[{pointOwner:e.id,x:t.x,y:t.y,z:t.z+e.l,type:"R",ignored:!1,prio:e.priority},{pointOwner:e.id,x:t.x+e.w,y:t.y,z:t.z,type:"F",ignored:!1,prio:e.priority}];if(t.x==0&&t.y==0&&t.z==0)return[...o,...i];let a=this.create2dSpace(t),r=a[0],l=a[1];if(r.length!=0&&Object.keys(l).length!=0)for(let n=0;n<i.length;n++){let c=i[n],s=0;for(let u=0;u<r.length;u++){let h=r[u],d=l[h.id],x={x:c.x+1,z:c.z+1};if(c.y==0)this.isPointContainedInSpace(d,x,!1)||s++;else if(this.isPointContainedInSpace(d,x,!1)){let y=this.packagesLoaded.filter(m=>m.x<=c.x+1&&m.x+m.w>c.x+1&&m.z<=c.z+1&&m.z+m.l>c.z+1&&m.y==t.y&&m.id!=c.pointOwner);c.type=="R"&&d[3].z-c.z,c.type=="F"&&d[3].x-c.x,y.length==0&&(c.type=="R"&&o.push(i[0]),c.type=="F"&&o.push(i[1]))}}s==r.length&&(c.type=="R"&&o.push(i[0]),c.type=="F"&&o.push(i[1]))}return o}createPack(t,e){this.packagesLoaded.push(j(L(L({},t),e),{openPoint:{R:{x:e.x,y:e.y,z:e.z+t.l},T:{x:e.x,y:e.y+t.h,z:e.z},F:{x:e.x+t.w,y:e.y,z:e.z}}})),this.openPoints.push(...this.createOpenPoints(e,t)),this.boxes.push(this.createTemperoryBox(t,e))}}function Be(g,t){let e=new f.Group;e.name="All_Packs",t.forEach(a=>{let r=new f.BoxGeometry(a.w,a.h,a.l),l=new f.MeshLambertMaterial({color:a.color*16715775,side:f.DoubleSide}),n=new f.Vector3(a.x,a.y,a.z),c=new f.Group;c.name="Box_Border_"+a.parent_id;let s=new f.Mesh(r,l);s.castShadow=!0,s.receiveShadow=!0,s.name="Pack",s.userData.id=a.parent_id,s.userData.clickable=!1,s.userData.actif=!1,s.userData.name="Pack";let u=new f.EdgesGeometry(r),h=new f.LineSegments(u,new f.LineBasicMaterial({color:16777215}));h.name="Line_"+a.id,h.position.copy(n),h.userData.id=a.parent_id,h.userData.name="Line",h.translateX(a.w/2),h.translateY(a.h/2),h.translateZ(a.l/2),s.position.copy(n),r.translate(a.w/2,a.h/2,a.l/2),c.add(s),c.add(h),e.add(c)});var o=gsap.timeline();for(let a=0;a<e.children.length;a++)o.from(e.children[a].position,{x:2e3,y:0,z:0,ease:Bounce.easeOut,duration:.02,onUpdate:()=>e.children[0].position.needsUpdate=!0});let i=new f.Group;i.name="sphere",g.forEach(a=>{const r=new f.SphereGeometry(3,32,16),l=new f.MeshBasicMaterial({color:16776960}),n=new f.Mesh(r,l);n.position.set(a.x,a.y,a.z),i.add(n)}),v.add(i),v.add(e)}function Te(g,t){return g.filter(e=>!t.some(o=>e.id===o.parent_id))}function Re(g,t){$("#result").empty(),Ne(t);let e=t.reduce((r,l)=>{let n=l.parent_id,c=g.filter(s=>s.id==n)[0].q;return r[n]==null&&(r[n]={id:l.parent_id,label:l.label,loaded:0,unloaded:0}),r[n].loaded=r[n].loaded+1,r[n].unloaded=c-r[n].loaded,r},{}),i=Te(g,t).reduce((r,l)=>(r[l.id]==null&&(r[l.id]={id:l.id,label:l.label,loaded:0,unloaded:l.q}),r),{}),a=L(L({},e),i);for(let r=0;r<I.allInstances.length;r++){let l=I.allInstances[r].id;I.allInstances[r]=j(L({},I.allInstances[r]),{loaded:a[l].loaded,unloaded:a[l].unloaded})}for(const r in a){let l="<span class='result-text'><b>Id</b><span>"+a[r].id+"</span></span>",n="<span class='result-text'><b>Label</b><span>"+a[r].label+"</span></span>",c="<span class='result-text'><b>Loaded</b><span>"+a[r].loaded+"</span></span>",s="<span class='result-text'><b>Unloaded</b><span>"+a[r].unloaded+"</span></span>";$("#result").append("<div class='result-detail'>"+l+n+c+s+"</div>")}}function Ne(g){const t="data:text/csv;charset=utf-8,"+[["Id","Label","Width","Height","Lenght","X","Y","Z","RotationFace","RotationAngle"],...g.map(i=>[i.id,i.label,i.w,i.h,i.l,i.x,i.y,i.z,i.validRotation])].map(i=>i.join(",")).join(`
`);var e=encodeURI(t);let o="result_"+new Date().getTime()+".csv";$("#result").append("<a class='download-result' href="+e+" download="+o+"> Download <b>"+o+"</b> </div>")}$(document).ready(function(){const g=new Worker("src/worker.js",{type:"module"});var t=!1,e=JSON.parse(localStorage.getItem("container"));e!==null&&($("#containerWidth").val(e.w),$("#containerHeight").val(e.h),$("#containerLenght").val(e.l),$("#containerUnloading").val(e.unloading)),$("#routeIncrement").click(function(){let l=parseInt($("#routesNumber").val());$("#routesNumber").val(l+1),o()}),$("#routeDecrement").click(function(){let l=parseInt($("#routesNumber").val());l>1&&($("#routesNumber").val(l-1),$("#routeInputs .inputs").last().remove())});function o(){$("#routeInputs").append(`
            <div class="inputs">
                <div>
                    <p class="inputLabel">From</p>
                    <input type="text" class="input routeFrom" required>
                </div>
                <div>
                    <p class="inputLabel">To</p>
                    <input type="text" class="input routeTo" required>
                </div>
                <div>
                    <p class="inputLabel">Type</p>
                    <select class="input routeType" required>
                        <option value="dechargement">D</option>
                        <option value="chargement">C</option>
                        <option value="dechargement">D et C</option>
                    </select>
                </div>
            </div>`)}$("#routesForm").submit(function(l){l.preventDefault();var n={},c;n.routesNumber=$("#routesNumber").val(),n.from=$(".routeFrom").map(function(){return $(this).val()}).get(),n.to=$(".routeTo").map(function(){return $(this).val()}).get(),n.type=$(".routeType").map(function(){return $(this).val()}).get(),n.routes=[];for(let s=0;s<n.routesNumber;s++){let u={id:s+1,from:n.from[s],to:n.to[s],type:n.type[s]};n.routes.push(u)}c=new U(n.routesNumber,n.routes),c.add()}),$("#containerForm").submit(function(l){l.preventDefault();var n={};n.w=$("#containerWidth").val(),n.h=$("#containerHeight").val(),n.l=$("#containerLenght").val(),n.capacity=0,Oe(),new q(n.w,n.h,n.l,n.capacity),new O(n.w,n.h,n.l),t=!0}),$("#packForm").submit(function(l){if(l.preventDefault(),!t){alert("create the container");return}var n={},c;n.label=$("#packLabel").val(),n.w=$("#packWidth").val(),n.h=$("#packHeight").val(),n.l=$("#packLenght").val(),n.q=$("#packQuantity").val(),n.stack=$("#packStackingCapacity").val(),n.priority=$("#packPriority").val(),n.r=["base"],$("#rightSide").is(":checked")&&n.r.push("right-side"),$("#frontSide").is(":checked")&&n.r.push("front-side"),c=new I(n.label,n.w,n.h,n.l,n.q,n.stack,n.r,n.priority,[]),c.add();var s=n.w+" , "+n.h+" , "+n.l+" ( "+n.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+n.label+'</div><div class="packInfo-numbers">'+s+" </div></div>")}),$("#solve").click(function(){if(!t){alert("create the container");return}I.removePacksFromTheScene(),v.remove(v.getObjectByName("sphere"));var l=new Fe("cub"),n=l.initialisePackagesToLoad();new F("Loading",.01).dispatchMessage(),g.postMessage([q.instances,n]),g.onmessage=s=>{Be(s.data.packer[0],s.data.packer[1]),Re(I.allInstances,s.data.packer[1]),$("#numberBox").val(s.data.packer[1].length),new F("Loaded",s.data.executionTime).dispatchMessage()}}),I.loadPacksFromLocalStorage(),$("#updatePack").click(function(l){l.preventDefault();var n={};n.id=$("#pack_Detail_Id").val(),n.label=$("#pack_Detail_Label").val(),n.w=$("#pack_Detail_Width").val()*w,n.h=$("#pack_Detail_Height").val()*w,n.l=$("#pack_Detail_Lenght").val()*w,n.q=$("#pack_Detail_Quantity").val(),n.stack=$("#pack_Detail_StackingCapacity").val(),n.priority=$("#pack_Detail_Priority").val(),n.r=["base"],$("#pack_Detail_right-side").is(":checked")&&n.r.push("right-side"),$("#pack_Detail_front-side").is(":checked")&&n.r.push("front-side");let c=i(".sub-q"),s=i(".sub-prio"),u=[];for(let h=0;h<c.length;h++){let d=c[h],x=s[h];u.push({n:d,p:x})}n.subQuantities=u,I.update(n,n.id),I.removeBoxesFromTheScene(),I.loadPacks()});function i(l){let n=$(l),c=[];for(let s=0;s<n.length;s++){let u=n[s];c.push(parseInt(u.value))}return c}$("#deletePack").click(function(l){l.preventDefault();let n=$("#pack_Detail_Id").val();I.remove(n),I.removeBoxesFromTheScene(),I.loadPacks()}),$("#actual-btn").change(function(l){var n=$("#actual-btn").val().split(".").pop().toLowerCase();if($.inArray(n,["csv"])==-1)return alert("Upload CSV"),!1;if(l.target.files!=null){$("#file-chosen").html(l.target.files[0].name);var c=new FileReader;c.onload=function(s){var u=s.target.result.split(`\r
`);a(u)},c.readAsText(l.target.files.item(0))}return!1});function a(l){for(let s=1;s<l.length;s++)if(l[s].length>0){let u=l[s].split(",");if(u[0]=="container")new q(u[1],u[2],u[3],u[4]),t=!0;else{let h=[];for(let d=6;d<=8;d++)u[d]!=null&&h.push(u[d].replace('"',""));var n=new I(u[0],u[1],u[2],u[3],u[4],u[5],[...h]);n.add();var c=u[1]+" , "+u[2]+" , "+u[3]+" ( "+u[4]+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+u[0]+'</div><div class="packInfo-numbers">'+c+" </div></div>")}}}$("#numberBox").on("input",function(l){if(l.target.value!=null&&v.getObjectByName("All_Packs")){let n=v.getObjectByName("All_Packs").children;l.target.max=n.length;for(let c=l.target.value-1;c>=0;c--){let s=n[c].children,u=s[0],h=s[1];u.visible=!0,h.visible=!0}for(let c=n.length-1;c>=l.target.value;c--){let s=n[c].children,u=s[0],h=s[1];u.visible=!1,h.visible=!1}}}),$("#loadApi").click(async function(){let l=$("#apiUrl").val();await fetch(l).then(n=>{if(n.ok)return n.json()}).then(n=>{console.log(n),r(n)}).catch(n=>console.log(n))});function r(l){console.log(l);let n=l.container,c=l.colis;new q(n.w,n.h,n.l,n.capacity,n.unloading),t=!0,c.map(h=>{var h=new I(h.label,h.w,h.h,h.l,h.q,h.stackingCapacity,h.rotations,h.priority);h.add()}),new F("Load Data",.01).dispatchMessage()}$("#random").click(function(){$("#packLabel").val("colis "+Math.floor(Math.random()*100)),$("#packWidth").val(Math.floor((Math.random()*(2-.1+1)+.1)*100)/100),$("#packHeight").val(Math.floor((Math.random()*(2-.1+1)+.1)*100)/100),$("#packLenght").val(Math.floor((Math.random()*(2-.1+1)+.1)*100)/100),$("#packQuantity").val(Math.floor(Math.random()*20+1))})});
