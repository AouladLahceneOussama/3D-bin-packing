var R=Object.defineProperty,A=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var N=Object.getOwnPropertySymbols;var E=Object.prototype.hasOwnProperty,j=Object.prototype.propertyIsEnumerable;var F=(c,t,e)=>t in c?R(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e,y=(c,t)=>{for(var e in t||(t={}))E.call(t,e)&&F(c,e,t[e]);if(N)for(var e of N(t))j.call(t,e)&&F(c,e,t[e]);return c},_=(c,t)=>A(c,G(t));var D=(c,t,e)=>(F(c,typeof t!="symbol"?t+"":t,e),e);import*as h from"https://threejsfundamentals.org/threejs/resources/threejs/r122/build/three.module.js";import{OrbitControls as H}from"https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/controls/OrbitControls.js";import{GLTFLoader as M}from"https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/loaders/GLTFLoader.js";const V=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function e(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerpolicy&&(n.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?n.credentials="include":a.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(a){if(a.ep)return;a.ep=!0;const n=e(a);fetch(a.href,n)}};V();$(document).ready(function(){$(".menuIcon").click(function(){$(".menu").toggleClass("openMenu closeMenu"),$(".menuIcon").toggleClass("openMenuIcon closeMenu")}),$(".closeMenuIcon").click(function(){$(".menu").toggleClass("openMenu closeMenu"),$(".menuIcon").toggleClass("openMenuIcon closeMenu")}),$("#reset").click(function(){localStorage.removeItem("container"),localStorage.removeItem("packages"),location.reload()}),$("#openCSV").click(function(){$("#openCSV").toggleClass("fa-circle-plus fa-circle-minus"),$("#csv").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openApi").click(function(){$("#openApi").toggleClass("fa-circle-plus fa-circle-minus"),$("#api").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openPackages").click(function(){$("#openPackages").toggleClass("fa-circle-plus fa-circle-minus"),$("#packages").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openVehicule").click(function(){$("#openVehicule").toggleClass("fa-circle-plus fa-circle-minus"),$("#vehicule").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openResult").click(function(){$("#openResult").toggleClass("fa-circle-plus fa-circle-minus"),$("#result").toggleClass("formContainerContentOpen formContainerContentClose")}),$("#openPackDetail").click(function(){$("#openPackDetail").toggleClass("fa-circle-plus fa-circle-minus"),$("#packDetail").toggleClass("pack-detail-close pack-detail-open")});var c=JSON.parse(localStorage.getItem("container"));if(c!==null){var t=c.w+" , "+c.h+" , "+c.l;$("#containerDetails").append("<span>"+t+"</span>")}});const u=100,p=new h.Scene,C=document.getElementById("3D-container");let J=0;const w=class{constructor(t,e,o,a,n,i,s,r){this.id=J++,this.label=t,this.w=parseInt(e*u),this.h=parseInt(o*u),this.l=parseInt(a*u),this.q=parseInt(n),this.v=this.w*this.h*this.l,this.stackingCapacity=parseInt(i),this.rotations=s,this.dimensions=this.setDimensions(s),this.priority=parseInt(r),this.color=Math.random(),w.allInstances.push(this.getPack)}get getPack(){return{id:this.id,label:this.label,w:this.w,h:this.h,l:this.l,q:this.q,v:this.v,priority:this.priority,stackC:this.stackingCapacity,rotations:this.dimensions,rotateDirections:this.rotations,color:this.color}}get getPackToLocalStorage(){return{label:this.label,w:this.w/u,h:this.h/u,l:this.l/u,q:this.q,priority:this.priority,stackC:this.stackingCapacity,rotations:this.rotations}}setDimensions(t){let e=[];for(let a=0;a<t.length;a++){let n=t[a];n=="base"&&e.push({w:this.w,h:this.h,l:this.l,type:[n,0],surface:this.w*this.l},{w:this.l,h:this.h,l:this.w,type:[n,90],surface:this.w*this.l}),n=="right-side"&&e.push({w:this.w,h:this.l,l:this.h,type:[n,0],surface:this.w*this.h},{w:this.h,h:this.l,l:this.w,type:[n,90],surface:this.w*this.h}),n=="front-side"&&e.push({w:this.h,h:this.w,l:this.l,type:[n,0],surface:this.h*this.l},{w:this.l,h:this.w,l:this.h,type:[n,90],surface:this.h*this.l})}e.sort((a,n)=>n.surface-a.surface);for(let a=0;a<e.length;a+=2)if(e[a].l>e[a].w){var o=e[a+1];e[a+1]=e[a],e[a]=o}return e}static init(){localStorage.getItem("packages")!==null&&(JSON.parse(localStorage.getItem("packages")).forEach(e=>{new w(e.label,e.w,e.h,e.l,e.q,e.stackC,e.rotations,e.priority)}),w.allInstances.forEach(e=>{var o=e.w/u+" , "+e.h/u+" , "+e.l/u+" ( "+e.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+e.label+'</div><div class="packInfo-numbers">'+o+" </div></div>")}))}add(){var t=[];localStorage.getItem("packages")!==null&&(t=JSON.parse(localStorage.getItem("packages"))),t.push(this.getPackToLocalStorage),localStorage.setItem("packages",JSON.stringify(t)),w.loadPacks()}static updatePackLocalstorage(){localStorage.removeItem("packages");let t=[];w.allInstances.map(e=>{t.push({label:e.label,w:parseFloat(e.w/u),h:parseFloat(e.h/u),l:parseFloat(e.l/u),q:parseInt(e.q),priority:e.priority,stackC:parseInt(e.stackC),rotations:e.rotateDirections})}),localStorage.setItem("packages",JSON.stringify(t))}static update(t,e){function o(r,l,d,m){let f=[];for(let g=0;g<r.length;g++){let v=r[g];v=="base"&&f.push({w:l,h:d,l:m,type:[v,0],surface:l*m},{w:m,h:d,l,type:[v,90],surface:l*m}),v=="right-side"&&f.push({w:l,h:m,l:d,type:[v,0],surface:l*d},{w:d,h:m,l,type:[v,90],surface:l*d}),v=="front-side"&&f.push({w:d,h:l,l:m,type:[v,0],surface:d*m},{w:m,h:l,l:d,type:[v,90],surface:d*m})}f.sort((g,v)=>v.surface-g.surface);for(let g=0;g<f.length;g+=2)if(f[g].l>f[g].w){var b=f[g+1];f[g+1]=f[g],f[g]=b}return f}let a=w.allInstances.findIndex(r=>r.id==parseInt(e)),n=w.allInstances[a],i={label:t.label,w:parseInt(t.w),h:parseInt(t.h),l:parseInt(t.l),q:parseInt(t.q),priority:parseInt(t.priority),v:t.w*t.h*t.l,stackC:parseInt(t.stack),rotateDirections:t.r,rotations:o(t.r,parseInt(t.w),parseInt(t.h),parseInt(t.l))},s=y(y({},n),i);w.allInstances[a]=s,w.removePacksFromTheScene(),w.updatePackLocalstorage(),$("#packageDetails").empty(),w.allInstances.forEach(r=>{var l=r.w/u+" , "+r.h/u+" , "+r.l/u+" ( "+r.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+r.label+'</div><div class="packInfo-numbers">'+l+" </div></div>")})}static remove(t){let e=w.allInstances.findIndex(o=>o.id==parseInt(t));w.allInstances.splice(e,1),w.removePacksFromTheScene(),w.updatePackLocalstorage(),$("#packageDetails").empty(),w.allInstances.forEach(o=>{var a=o.w/u+" , "+o.h/u+" , "+o.l/u+" ( "+o.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+o.label+'</div><div class="packInfo-numbers">'+a+" </div></div>")})}static loadPacks(){w.removeBoxesFromTheScene();let t=w.allInstances,e=new h.Group;e.name="pack_shower",t.sort((r,l)=>l.v-r.v);var o,a,n;let i=-300,s=400;for(let r=0;r<t.length;r++){let l=t[r];a=new h.BoxGeometry(l.w,l.h,l.l),n=new h.MeshLambertMaterial({color:l.color*16715775,side:h.DoubleSide}),o=new h.Mesh(a,n),o.castShadow=!0,o.receiveShadow=!0,o.userData.id=l.id,o.userData.clickable=!0,o.userData.actif=!1,o.userData.name="Pack",r!=0?o.position.set(i,-110-.1,s):o.position.set(i,-65,s),i+=l.w+20,i>800&&(s+=400,i=-300),a.translate(l.w/2,l.h/2,l.l/2),e.add(o)}p.add(e)}static loadPacksFromLocalStorage(){w.init(),w.loadPacks()}static removePacksFromTheScene(){p.remove(p.getObjectByName("All_Packs"))}static removeBoxesFromTheScene(){p.remove(p.getObjectByName("pack_shower"))}};let x=w;D(x,"allInstances",[]);const q=new h.Raycaster,L=new h.Vector2;function U(c){L.x=(c.clientX-C.offsetLeft)/(window.innerWidth-C.offsetLeft)*2-1,L.y=-((c.clientY-C.offsetTop)/(window.innerHeight-C.offsetTop))*2+1,q.setFromCamera(L,k);var t;if(p.getObjectByName("pack_shower")&&(t=q.intersectObjects(p.getObjectByName("pack_shower").children),t.length>0&&t[0].object.userData.clickable)){let e=t[0].object.userData.id;X(e),Z(e)}}function X(c){var t;p.traverse(e=>{(e.userData.name==="Pack"||e.userData.name=="Line")&&e.userData.id==c&&(t=e.userData.actif)}),p.traverse(e=>{(e.userData.name==="Pack"||e.userData.name=="Line")&&(t?(e.material.transparent=!1,e.material.opacity=1,e.userData.actif=!1,e.castShadow=!0):(e.userData.id==c&&(e.userData.actif=!0,e.material.transparent=!1,e.material.opacity=1,e.castShadow=!0),e.userData.id!=c&&(e.userData.actif=!1,e.material.transparent=!0,e.material.opacity=.2,e.castShadow=!1)))})}function Z(c){["base","right-side","front-side"].forEach(e=>{$(`#pack_Detail_${e}`).prop("checked",!1)});var t=x.allInstances.find(e=>e.id==c);$("#pack_Detail_Id").val(t.id),$("#pack_Detail_Label").val(t.label),$("#pack_Detail_Width").val(t.w/u),$("#pack_Detail_Height").val(t.h/u),$("#pack_Detail_Lenght").val(t.l/u),$("#pack_Detail_Quantity").val(t.q),$("#pack_Detail_StackingCapacity").val(t.stackC),$("#pack_Detail_Priority").val(t.priority),t.rotateDirections.forEach(e=>{$(`#pack_Detail_${e}`).prop("checked",!0)}),t.loaded!=null&&t.unloaded!=null&&$("#packStatut").html(" ("+t.loaded+" / "+(t.loaded+t.unloaded)+") ")}var k,I,P,O,B;Q();W();function Q(){const t=window.innerWidth/window.innerHeight,e=1,o=1e4;k=new h.PerspectiveCamera(60,t,e,o),k.position.set(1e3,400,800),p.background=new h.Color(16777215),p.fog=new h.FogExp2(9024235,2e-6),ee(),te(),ae(),ne(),ie();let a=new h.DirectionalLight(16777215,.8);a.position.set(120,1e3,-150),a.castShadow=!0,a.shadow.bias=-.001,a.shadow.mapSize.width=4096,a.shadow.mapSize.height=4096,a.shadow.camera.near=.5,a.shadow.camera.far=3e3,a.shadow.camera.left=3e3,a.shadow.camera.right=-3e3,a.shadow.camera.top=1e3,a.shadow.camera.bottom=-1e3,p.add(a),I=new h.WebGLRenderer({antialias:!0}),I.setPixelRatio(window.devicePixelRatio),I.setSize(C.clientWidth,C.clientHeight),I.shadowMap.enabled=!0,C.appendChild(I.domElement),P=new H(k,I.domElement),P.enableDamping=!0,P.minDistance=100,P.maxDistance=3e3,P.enablePan=!1,P.maxPolarAngle=Math.PI/2,P.minPolarAngle=-Math.PI/2,P.update(),window.addEventListener("resize",Y),C.addEventListener("click",U)}function Y(){k.aspect=window.innerWidth/window.innerHeight,k.updateProjectionMatrix(),I.setSize(window.innerWidth,window.innerHeight)}function W(){requestAnimationFrame(W),P.update(),K()}function K(){I.render(p,k)}function ee(){const c=new h.TextureLoader,t=c.load("/textures/ground/Concrete_019_basecolor.jpg"),e=c.load("/textures/ground/Concrete_019_normal.jpg"),o=c.load("/textures/ground/Concrete_019_height.png"),a=c.load("/textures/ground/Concrete_019_roughness.jpg"),n=c.load("/textures/ground/Concrete_019_ambientOcclusion.jpg"),i=1800,s=1800,r=6,l=6,d=new h.PlaneGeometry(i,s,10,10),m=new h.MeshStandardMaterial({map:t,normalMap:e,displacementMap:o,displacementScale:.3,roughnessMap:a,roughness:1,aoMap:n});for(let f=0;f<r;f++)for(let b=0;b<l;b++){const g=new h.Mesh(d,m);g.castShadow=!1,g.receiveShadow=!0,g.rotation.x=-Math.PI/2,g.position.y=-110,g.position.x=f*i-r/2*i,g.position.z=b*s-l/2*s,p.add(g)}}function te(){const c=`
  varying vec3 vWorldPosition;
  void main() {
    vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
    vWorldPosition = worldPosition.xyz;
    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
  }`,t=`
  uniform vec3 topColor;
  uniform vec3 bottomColor;
  uniform float offset;
  uniform float exponent;
  varying vec3 vWorldPosition;
  void main() {
    float h = normalize( vWorldPosition + offset ).y;
    gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h , 0.0), exponent ), 0.0 ) ), 1.0 );
  }`,e=new h.HemisphereLight(16777215,268435455,.6);e.color.setHSL(.6,1,.6),e.groundColor.setHSL(.095,1,.75),p.add(e);const o={topColor:{value:new h.Color(30719)},bottomColor:{value:new h.Color(16777215)},offset:{value:33},exponent:{value:.6}};o.topColor.value.copy(e.color),p.fog.color.copy(o.bottomColor.value);const a=new h.SphereBufferGeometry(4e3,32,15),n=new h.ShaderMaterial({uniforms:o,vertexShader:c,fragmentShader:t,side:h.BackSide}),i=new h.Mesh(a,n);p.add(i)}function ae(){new M().load("models/lift_truck/scene.gltf",function(c){const t=c.scene;t&&(t.getObjectByName("holders").translateZ(10),t.scale.set(300,300,300),t.position.set(-250,-90,450),t.rotation.y=-Math.PI,t.traverse(function(o){o.isMesh&&(o.castShadow=!0,o.receiveShadow=!0)}),p.add(t))}),new M().load("models/pallet_truck/scene.gltf",function(c){const t=c.scene;t&&(t.scale.set(1/2,1/2,1/2),t.position.set(-450,-25,700),t.rotation.y=Math.PI,t.traverse(function(e){e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),p.add(t))})}function ne(){new M().load("models/truck/truck-wheels.gltf",function(c){const t=c.scene;t&&(t.scale.set(1.5,2,1.5),t.rotation.y=Math.PI/2,t.traverse(function(e){e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),O=t)}),new M().load("models/truck/truck-support.gltf",function(c){const t=c.scene;t&&(t.scale.set(2,2.4,2),t.rotation.y=Math.PI/2,t.traverse(function(e){e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),B=t)})}function ie(){$(".cube__face").click(function(){let c=$(this).attr("role");c=="front"&&gsap.to(k.position,{duration:1,x:2e3,y:100,z:0,ease:"power3.inOut"}),c=="left"&&gsap.to(k.position,{duration:1,x:0,y:200,z:2e3,ease:"power3.inOut"}),c=="top"&&gsap.to(k.position,{duration:1,x:2e3,y:1e3,z:1200,ease:"power3.inOut"})})}function oe(){p.remove(p.getObjectByName("Full_Container")),p.remove(p.getObjectByName("All_Packs")),$("#result").empty()}const T=class{constructor(t,e,o,a){this.w=parseInt(t*u),this.h=parseInt(e*u),this.l=parseInt(o*u),this.capacity=parseInt(a),this.loadContainer(),T.instances=this.getContainer}get getContainer(){return{w:this.w,h:this.h,l:this.l,capacity:this.capacity}}get getContainerLocalStorage(){return{w:this.w/u,h:this.h/u,l:this.l/u,capacity:this.capacity}}loadContainer(){var t=new h.MeshLambertMaterial({color:9737364,side:h.DoubleSide}),e=new h.MeshLambertMaterial({color:9737364,side:h.DoubleSide,transparent:!0,opacity:.5}),o,a=new h.Group;a.name="Full_Container";const n=new h.BoxGeometry(this.w+5,5,this.l+5),i=new h.BoxGeometry(this.w+5,this.h,5),s=new h.BoxGeometry(5,this.h,this.l);n.translate(this.w/2-5/2,-5/2-.1,this.l/2-5/2),i.translate(this.w/2-5/2,this.h/2,-5/2-.1),s.translate(-5/2-.1,this.h/2,this.l/2),o=new h.Mesh(n,t),a.add(o),o.castShadow=!0,o.receiveShadow=!0,o=new h.Mesh(i,e),a.add(o),o=new h.Mesh(s,e),a.add(o),this.loadTruck(this.w,this.l,a),localStorage.setItem("container",JSON.stringify(this.getContainerLocalStorage))}loadTruck(t,e,o){O.position.set(t-440,-110,e/2),B.position.set(400,-110,e/2),o.add(O),o.add(B),p.add(o)}};let S=T;D(S,"instances");class le{constructor(t){D(this,"isPointContainedInSpace",(t,e,o)=>o?e.x>t[0].x&&e.x<=t[3].x&&e.z>t[0].z&&e.z<=t[3].z:e.x>=t[0].x&&e.x<=t[3].x&&e.z>=t[0].z&&e.z<=t[3].z);this.algorithm=t,this.packagesLoaded=[],this.openPoints=[],this.boxes=[]}initialisePackagesToLoad(){var t,e=[],o=[];x.allInstances.map(n=>{for(var i=0;i<n.q;i++)t=_(y({},n),{w:n.rotations[0].w,h:n.rotations[0].h,l:n.rotations[0].l,id:n.id+"-"+i,parent_id:n.id}),delete t.q,e.push(t)});let a=e.reduce((n,i)=>{const s=i.priority;return n[s]==null&&(n[s]=[]),n[s].push(i),n},{});return Object.entries(a).forEach(([n,i])=>{o.push(parseInt(n)),i.sort((s,r)=>r.v-s.v)}),o.sort((n,i)=>n-i),[a,o]}canFit(t,e){return e.w<=t.w&&e.l<=t.l&&e.h<=t.h}getDownPack(t,e,o){return t==-1||t.parent_id!=o?e:(t=this.getPackByTopCoords({x:t.x,y:t.y,z:t.z}),e++,this.getDownPack(t,e,o))}getPackByTopCoords(t){return this.packagesLoaded.filter(o=>o.openPoint.T.x==t.x&&o.openPoint.T.y==t.y&&o.openPoint.T.z==t.z)[0]||-1}canBeStacked(t,e){let o=this.getPackByOpenPoint(e);return o.parent_id==t.parent_id?this.getDownPack(o,0,t.parent_id)<=t.stackC:!0}create2dSpace(t){let e=this.packagesLoaded.filter(a=>(t.y>0?a.y+a.h:a.y)==t.y),o=[];return e.forEach(a=>{o[a.id]==null&&(o[a.id]=[]),o[a.id].push({x:a.x,z:a.z},{x:a.x+a.w,z:a.z},{x:a.x,z:a.z+a.l},{x:a.x+a.w,z:a.z+a.l})}),[e,o]}canFitAboveTheBoxNewVersion(t,e){let o=[{x:e.x,z:e.z},{x:(3*e.x+(e.x+t.w))/4,z:e.z},{x:(e.x+(e.x+t.w))/2,z:e.z},{x:(e.x+3*(e.x+t.w))/4,z:e.z},{x:e.x+t.w,z:e.z},{x:e.x,z:(e.z+3*(e.z+t.l))/4},{x:e.x,z:(e.z+(e.z+t.l))/2},{x:e.x,z:(3*e.z+(e.z+t.l))/4},{x:e.x,z:e.z+t.l},{x:(e.x+3*(e.x+t.w))/4,z:e.z+t.l},{x:(e.x+(e.x+t.w))/2,z:e.z+t.l},{x:(3*e.x+(e.x+t.w))/4,z:e.z+t.l},{x:e.x+t.w,z:e.z+t.l},{x:e.x+t.w,z:(e.z+3*(e.z+t.l))/4},{x:e.x+t.w,z:(e.z+(e.z+t.l))/2},{x:e.x+t.w,z:(3*e.z+(e.z+t.l))/4}],a=this.create2dSpace(e),n=a[0],i=a[1],s=0;for(let r=0;r<o.length;r++)for(let l=0;l<n.length;l++){let d=n[l],m=o[r],f=i[d.id];if(this.isPointContainedInSpace(f,m,!1)){s++;break}}return s==16}packTakeToMuchSpace(t,e){let a=this.openPoints.filter(n=>n.y==0&&n.z==0);return a.sort((n,i)=>i.x-n.x),!(t.x!=a[0].x&&t.x+e.w>a[0].x)}okRotation(t,e){for(let o=0;o<this.openPoints.length;o++){let a=this.openPoints[o],n=y({},e);if(!(a.y>0&&a.type=="T"&&e.stackC!=-1&&!this.canBeStacked(e,a))){for(let i=0;i<e.rotations.length;i++){let s=e.rotations[i];if(s.l+a.z<=t.l&&s.h+a.y<=t.h&&s.w+a.x<=t.w){let r=this.createTemperoryBox(s,a);if(this.checkCollision(r)||a.y>0&&!this.canFitAboveTheBoxNewVersion(s,a))continue;return n.w=s.w,n.l=s.l,n.h=s.h,n.validRotation=s.type,[a,o,n]}}if(o==this.openPoints.length-1)return!1}}}removeNonWorkingOpenPoints(t){let e=this.packagesLoaded[this.packagesLoaded.length-1];for(let a=0;a<this.openPoints.length;a++){let n=this.openPoints[a],i=n.pointOwner.split("-")[0];for(let s=a+1;s<this.openPoints.length;s++){let r=this.openPoints[s],l=r.pointOwner.split("-")[0];n.x==r.x&&n.y==r.y&&i==l&&this.openPoints.splice(s,1),n.x==r.x&&n.z==r.z&&i==l&&this.openPoints.splice(s,1),n.y==r.y&&n.z==r.z&&i==l&&this.openPoints.splice(s,1)}}for(let a=this.openPoints.length-1;a>=0;a--){let n=this.openPoints[a];(t.w==n.x||t.h==n.y||t.l==n.z)&&this.openPoints.splice(a,1)}let o=[];this.openPoints.map((a,n)=>{a.x+1>=e.x&&a.x+1<=e.x+e.w&&a.z+1>=e.z&&a.z+1<=e.z+e.l&&a.y>0&&a.y==e.y&&a.pointOwner!=e.id&&o.push(n)}),o.sort((a,n)=>n-a);for(let a=o.length-1;a>=0;a--)this.openPoints.splice(o[a],1)}refreshOpenPoints(t,e){this.openPoints.splice(t,1),this.openPoints=this.removeDuplicatesObjectFromArray(this.openPoints),this.openPoints.sort((o,a)=>o.x-a.x||o.z-a.z||o.y-a.y),this.removeNonWorkingOpenPoints(e)}removeDuplicatesObjectFromArray(t){return t.filter((e,o,a)=>a.findIndex(n=>n.x===e.x&&n.y===e.y&&n.z===e.z)===o)}getDifference(t,e){return t.filter(o=>!e.some(a=>o.id===a.parent_id))}removeOpenPointForNextPriority(){for(let t=this.openPoints.length-1;t>=0;t--){let e=this.openPoints[t];(e.type=="T"||e.type=="F"&&e.y>0)&&this.openPoints.splice(t,1)}}getIndexes(t){let e=[];return this.openPoints.map((o,a)=>{parseInt(o.pointOwner.split("-")[0])==t.parent_id&&o.type=="T"&&e.push({index:a,data:o})}),e.sort((o,a)=>o.index-a.index),e}removeDiagonalPoints(t){let e=this.getIndexes(t);if(e.length>=2)for(let o=0;o<e.length;o++){let a=e[o];console.log(e);for(let n=o+1;n<e.length;n++){let i=e[n];Math.abs(i.data.z-a.data.z)%2==0&&(this.openPoints.splice(i.index,1),e=this.getIndexes(t))}}}solve(t,e,o){let a=Object.keys(e)[0][0];for(let n=0;n<o.length;n++){let i=e[o[n]];for(let s=0;s<i.length;s++){let r=i[s];if(n==0&&s==0)this.canFit(t,r)&&this.createPack(r,{x:0,y:0,z:0});else{let l=this.okRotation(t,r);l!==!1&&(this.createPack(l[2],l[0]),this.refreshOpenPoints(l[1],t),a.parent_id!=r.parent_id&&this.removeDiagonalPoints(a),a=r)}}}return this.removeDiagonalPoints(a),console.log("packagesLoaded => "),console.log(this.packagesLoaded),console.log("openPoints => "),console.log(this.openPoints),[this.openPoints,this.packagesLoaded]}checkCollision(t){t.geometry.computeBoundingBox(),t.updateMatrixWorld();let e=t.geometry.boundingBox.clone();e.applyMatrix4(t.matrixWorld),e.max.x=e.max.x-1,e.max.y=e.max.y-1,e.max.z=e.max.z-1,e.min.x=e.min.x+1,e.min.y=e.min.y+1,e.min.z=e.min.z+1;for(let o=0;o<this.boxes.length;o++){let a=this.boxes[o];a.geometry.computeBoundingBox(),a.updateMatrixWorld();let n=a.geometry.boundingBox.clone();if(n.applyMatrix4(a.matrixWorld),n.max.x=n.max.x-1,n.max.y=n.max.y-1,n.max.z=n.max.z-1,n.min.x=n.min.x+1,n.min.y=n.min.y+1,n.min.z=n.min.z+1,e.intersectsBox(n))return e.intersectsBox(n)}return!1}createTemperoryBox(t,e){let o=new h.MeshLambertMaterial({color:t.color*16715775,side:h.DoubleSide}),a=new h.BoxGeometry(t.w,t.h,t.l),n=new h.Mesh(a,o),i=new h.Vector3(e.x,e.y,e.z);return n.position.copy(i),a.translate(t.w/2,t.h/2,t.l/2),n}getPackByOpenPoint(t){return this.packagesLoaded.filter(o=>o.id===t.pointOwner)[0]}getPackById(t){return this.packagesLoaded.filter(o=>o.parent_id===t)[0]}createOpenPoints(t,e){let o=[{pointOwner:e.id,x:t.x,y:t.y+e.h,z:t.z,type:"T"}],a=[{pointOwner:e.id,x:t.x,y:t.y,z:t.z+e.l,type:"R"},{pointOwner:e.id,x:t.x+e.w,y:t.y,z:t.z,type:"F"}];if(t.x==0&&t.y==0&&t.z==0)return[...o,...a];let n=this.create2dSpace(t),i=n[0],s=n[1];if(i.length!=0&&Object.keys(s).length!=0)for(let r=0;r<a.length;r++){let l=a[r],d=0;for(let m=0;m<i.length;m++){let f=i[m],b=s[f.id],g={x:l.x+1,z:l.z+1};l.y==0?this.isPointContainedInSpace(b,g,!1)||d++:this.isPointContainedInSpace(b,g,!1)&&this.packagesLoaded.filter(z=>z.x<=l.x&&z.x+z.w>l.x&&z.z<=l.z&&z.z+z.l>l.z&&z.y==t.y&&z.id!=l.pointOwner).length==0&&(l.type=="R"&&o.push(a[0]),l.type=="F"&&o.push(a[1]))}d==i.length&&(l.type=="R"&&o.push(a[0]),l.type=="F"&&o.push(a[1]))}return o}createPack(t,e){this.packagesLoaded.push(y(y({},t),e)),this.openPoints.push(...this.createOpenPoints(e,t)),this.boxes.push(this.createTemperoryBox(t,e))}}function se(c,t){let e=new h.Group;e.name="All_Packs",t.forEach(n=>{let i=new h.BoxGeometry(n.w,n.h,n.l),s=new h.MeshLambertMaterial({color:n.color*16715775,side:h.DoubleSide}),r=new h.Vector3(n.x,n.y,n.z),l=new h.Group;l.name="Box_Border_"+n.parent_id;let d=new h.Mesh(i,s);d.castShadow=!0,d.receiveShadow=!0,d.name="Pack",d.userData.id=n.parent_id,d.userData.clickable=!1,d.userData.actif=!1,d.userData.name="Pack";let m=new h.EdgesGeometry(i),f=new h.LineSegments(m,new h.LineBasicMaterial({color:16777215}));f.name="Line_"+n.id,f.position.copy(r),f.userData.id=n.parent_id,f.userData.name="Line",f.translateX(n.w/2),f.translateY(n.h/2),f.translateZ(n.l/2),d.position.copy(r),i.translate(n.w/2,n.h/2,n.l/2),l.add(d),l.add(f),e.add(l)});var o=gsap.timeline();for(let n=0;n<e.children.length;n++)o.from(e.children[n].position,{x:2e3,y:0,z:0,ease:Bounce.easeOut,duration:.02,onUpdate:()=>e.children[0].position.needsUpdate=!0});let a=new h.Group;a.name="sphere",c.forEach(n=>{const i=new h.SphereGeometry(3,32,16),s=new h.MeshBasicMaterial({color:16776960}),r=new h.Mesh(i,s);r.position.set(n.x,n.y,n.z),a.add(r)}),p.add(a),p.add(e)}function re(c,t){return c.filter(e=>!t.some(o=>e.id===o.parent_id))}function ce(c,t){$("#result").empty(),he(t);let e=t.reduce((i,s)=>{let r=s.parent_id,l=c.filter(d=>d.id==r)[0].q;return i[r]==null&&(i[r]={id:s.parent_id,label:s.label,loaded:0,unloaded:0}),i[r].loaded=i[r].loaded+1,i[r].unloaded=l-i[r].loaded,i},{}),a=re(c,t).reduce((i,s)=>(i[s.id]==null&&(i[s.id]={id:s.id,label:s.label,loaded:0,unloaded:s.q}),i),{}),n=y(y({},e),a);for(let i=0;i<x.allInstances.length;i++){let s=x.allInstances[i].id;x.allInstances[i]=_(y({},x.allInstances[i]),{loaded:n[s].loaded,unloaded:n[s].unloaded})}for(const i in n){let s="<span class='result-text'><b>Id</b><span>"+n[i].id+"</span></span>",r="<span class='result-text'><b>Label</b><span>"+n[i].label+"</span></span>",l="<span class='result-text'><b>Loaded</b><span>"+n[i].loaded+"</span></span>",d="<span class='result-text'><b>Unloaded</b><span>"+n[i].unloaded+"</span></span>";$("#result").append("<div class='result-detail'>"+s+r+l+d+"</div>")}}function he(c){const t="data:text/csv;charset=utf-8,"+[["Id","Label","Width","Height","Lenght","X","Y","Z","RotationFace","RotationAngle"],...c.map(a=>[a.id,a.label,a.w,a.h,a.l,a.x,a.y,a.z,a.validRotation])].map(a=>a.join(",")).join(`
`);var e=encodeURI(t);let o="result_"+new Date().getTime()+".csv";$("#result").append("<a class='download-result' href="+e+" download="+o+"> Download <b>"+o+"</b> </div>")}$(document).ready(function(){const c=new Worker("src/worker.js",{type:"module"});var t=!1,e=JSON.parse(localStorage.getItem("container"));e!==null&&($("#containerWidth").val(e.w),$("#containerHeight").val(e.h),$("#containerLenght").val(e.l)),$("#containerForm").submit(function(n){n.preventDefault();var i={};i.w=$("#containerWidth").val(),i.h=$("#containerHeight").val(),i.l=$("#containerLenght").val(),i.weight=0,oe(),new S(i.w,i.h,i.l,0),t=!0;var s=JSON.parse(localStorage.getItem("container"));if(s!==null){var r=s.w+" , "+s.h+" , "+s.l;$("#containerDetails").html("<span>"+r+"</span>")}}),$("#packForm").submit(function(n){if(n.preventDefault(),!t){alert("create the container");return}var i={},s;i.label=$("#packLabel").val(),i.w=$("#packWidth").val(),i.h=$("#packHeight").val(),i.l=$("#packLenght").val(),i.q=$("#packQuantity").val(),i.stack=$("#packStackingCapacity").val(),i.priority=$("#packPriority").val(),i.r=["base"],$("#rightSide").is(":checked")&&i.r.push("right-side"),$("#frontSide").is(":checked")&&i.r.push("front-side"),s=new x(i.label,i.w,i.h,i.l,i.q,i.stack,i.r,i.priority),s.add();var r=i.w+" , "+i.h+" , "+i.l+" ( "+i.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+i.label+'</div><div class="packInfo-numbers">'+r+" </div></div>")}),$("#solve").click(function(){if(!t){alert("create the container");return}x.removePacksFromTheScene(),p.remove(p.getObjectByName("sphere"));var n=new le("cub"),i=n.initialisePackagesToLoad();console.log("solving"),c.postMessage([S.instances,i]),c.onmessage=s=>{console.log("solved"),se(s.data[0],s.data[1]),ce(x.allInstances,s.data[1]),$("#numberBox").val(s.data[1].length)}}),x.loadPacksFromLocalStorage(),$("#updatePack").click(function(n){n.preventDefault();var i={};i.id=$("#pack_Detail_Id").val(),i.label=$("#pack_Detail_Label").val(),i.w=$("#pack_Detail_Width").val()*u,i.h=$("#pack_Detail_Height").val()*u,i.l=$("#pack_Detail_Lenght").val()*u,i.q=$("#pack_Detail_Quantity").val(),i.stack=$("#pack_Detail_StackingCapacity").val(),i.priority=$("#pack_Detail_Priority").val(),i.r=["base"],$("#pack_Detail_right-side").is(":checked")&&i.r.push("right-side"),$("#pack_Detail_front-side").is(":checked")&&i.r.push("front-side"),x.update(i,i.id),x.removeBoxesFromTheScene(),x.loadPacks()}),$("#deletePack").click(function(n){n.preventDefault();let i=$("#pack_Detail_Id").val();x.remove(i),x.removeBoxesFromTheScene(),x.loadPacks()}),$("#actual-btn").change(function(n){var i=$("#actual-btn").val().split(".").pop().toLowerCase();if($.inArray(i,["csv"])==-1)return alert("Upload CSV"),!1;if(n.target.files!=null){$("#file-chosen").html(n.target.files[0].name);var s=new FileReader;s.onload=function(r){var l=r.target.result.split(`\r
`);o(l)},s.readAsText(n.target.files.item(0))}return!1});function o(n){for(let r=1;r<n.length;r++)if(n[r].length>0){let l=n[r].split(",");if(l[0]=="container")new S(l[1],l[2],l[3],l[4]),t=!0;else{let d=[];for(let m=6;m<=8;m++)l[m]!=null&&d.push(l[m].replace('"',""));var i=new x(l[0],l[1],l[2],l[3],l[4],l[5],[...d]);i.add();var s=l[1]+" , "+l[2]+" , "+l[3]+" ( "+l[4]+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+l[0]+'</div><div class="packInfo-numbers">'+s+" </div></div>")}}}$("#numberBox").on("input",function(n){if(n.target.value!=null&&p.getObjectByName("All_Packs")){let i=p.getObjectByName("All_Packs").children;n.target.max=i.length;for(let s=n.target.value-1;s>=0;s--){let r=i[s].children,l=r[0],d=r[1];l.visible=!0,d.visible=!0}for(let s=i.length-1;s>=n.target.value;s--){let r=i[s].children,l=r[0],d=r[1];l.visible=!1,d.visible=!1}}}),$("#loadApi").click(async function(){let n=$("#apiUrl").val();await fetch(n).then(i=>{if(i.ok)return i.json()}).then(i=>{console.log(i),a(i)}).catch(i=>console.log(i))});function a(n){console.log(n);let i=n.container,s=n.colis;new S(i.w,i.h,i.l,i.capacity),t=!0,s.map(l=>{var l=new x(l.label,l.w,l.h,l.l,l.q,l.stackingCapacity,l.rotations,l.priority);l.add();var d=l.w+" , "+l.h+" , "+l.l+" ( "+l.q+" ) ";$("#packageDetails").append('<div class="packInfo"><div>'+l.label+'</div><div class="packInfo-numbers">'+d+" </div></div>")})}$("#random").click(function(){$("#packLabel").val("colis "+Math.floor(Math.random()*100)),$("#packWidth").val(Math.floor((Math.random()*(2-.1+1)+.1)*100)/100),$("#packHeight").val(Math.floor((Math.random()*(2-.1+1)+.1)*100)/100),$("#packLenght").val(Math.floor((Math.random()*(2-.1+1)+.1)*100)/100),$("#packQuantity").val(Math.floor(Math.random()*20+1))})});
